<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë§ˆì¸ì¦ˆë§ˆì¼€íŒ… ë¸”ë¡œê·¸ ì²´í—˜ë‹¨ ê´€ë¦¬</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{--bg:#f8f9fa;--sf:#ffffff;--sf2:#f1f3f5;--bd:#e0e4e8;--a:#03c75a;--a2:#00b96b;--a3:#f7c948;--t:#1a1a1a;--m:#888ea8;--dn:#e53935;--end:#7c4dff;--pay:#00b96b;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--t);height:100vh;display:flex;flex-direction:column;overflow:hidden;}
header{display:flex;align-items:center;justify-content:space-between;padding:9px 18px;border-bottom:1px solid var(--bd);background:#fff;flex-shrink:0;z-index:200;box-shadow:0 1px 4px rgba(0,0,0,.06);}
.logo{font-size:15px;font-weight:700;color:#1a1a1a;}.logo span{color:var(--a);}
.logo small{font-size:10px;color:var(--m);font-weight:400;margin-left:6px;}
.chrome-tabbar{display:flex;align-items:flex-end;padding:5px 14px 0;background:#fff;border-bottom:2px solid var(--bd);flex-shrink:0;overflow-x:auto;scrollbar-width:none;gap:2px;}
.chrome-tabbar::-webkit-scrollbar{display:none;}
.ct{display:flex;align-items:center;gap:5px;padding:6px 12px 7px;border-radius:8px 8px 0 0;font-size:12px;font-weight:500;cursor:pointer;border:1px solid transparent;border-bottom:none;background:rgba(0,0,0,.02);color:var(--m);font-family:inherit;white-space:nowrap;min-width:90px;max-width:180px;transition:all .15s;margin-bottom:-1px;}
.ct:hover{background:rgba(3,199,90,.05);color:var(--t);}
.ct.active{background:#fff;color:var(--a);border-color:var(--bd);font-weight:700;}
.ct-label{flex:1;overflow:hidden;text-overflow:ellipsis;}
.ct-x{width:15px;height:15px;border-radius:50%;border:none;background:transparent;color:transparent;font-size:11px;cursor:pointer;padding:0;font-family:inherit;transition:all .15s;}
.ct:hover .ct-x,.ct.active .ct-x{color:var(--m);}
.ct-x:hover{background:var(--dn)!important;color:#fff!important;}
.ct-add{padding:5px 10px 6px;border-radius:6px 6px 0 0;border:none;background:transparent;color:var(--m);cursor:pointer;font-size:18px;line-height:1;transition:all .15s;font-family:inherit;align-self:flex-end;}
.ct-add:hover{color:var(--a);background:rgba(3,199,90,.08);}
.app-body{display:flex;flex:1;overflow:hidden;}
.panel{flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden;}
.panel+.panel{border-left:2px solid var(--bd);}
.panel-nav{display:flex;align-items:center;gap:0;padding:0 8px;background:#fff;border-bottom:2px solid var(--bd);overflow-x:auto;flex-shrink:0;scrollbar-width:none;}
.panel-nav::-webkit-scrollbar{display:none;}
.pnav-tab{padding:10px 12px;font-size:12px;font-weight:500;cursor:pointer;border:none;background:transparent;color:var(--m);transition:all .15s;font-family:inherit;white-space:nowrap;border-bottom:3px solid transparent;margin-bottom:-2px;}
.pnav-tab:hover{color:var(--a);}
.pnav-tab.active{color:var(--a);border-bottom-color:var(--a);font-weight:700;}
.panel-close{margin-left:auto;padding:3px 7px;border-radius:5px;border:none;background:transparent;color:var(--m);cursor:pointer;font-size:13px;font-family:inherit;flex-shrink:0;}
.panel-close:hover{color:var(--dn);}
.panel-content{flex:1;overflow-y:auto;padding:14px 16px;background:var(--bg);}
.stitle{font-size:16px;font-weight:700;margin-bottom:2px;color:var(--t);}
.ssub{color:var(--m);font-size:11px;margin-bottom:10px;}
.card{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:12px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,.04);}
.ctitle{font-size:11px;font-weight:700;color:var(--m);text-transform:uppercase;letter-spacing:.4px;margin-bottom:7px;}
.lbl{font-size:11px;color:var(--m);display:block;margin-bottom:2px;}
input,textarea,select{background:#fff;border:1px solid var(--bd);border-radius:8px;color:var(--t);font-family:'Noto Sans KR',sans-serif;font-size:12px;padding:6px 9px;outline:none;transition:border .15s;width:100%;}
input:focus,textarea:focus,select:focus{border-color:var(--a);box-shadow:0 0 0 2px rgba(3,199,90,.1);}
textarea{resize:vertical;}select option{background:#fff;}
.btn{padding:5px 11px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;border:none;transition:all .15s;white-space:nowrap;font-family:inherit;}
.btn-p{background:var(--a);color:#fff;}.btn-p:hover{opacity:.88;}
.btn-s{background:#fff;color:var(--t);border:1px solid var(--bd);}.btn-s:hover{border-color:var(--a);color:var(--a);}
.btn-g{background:var(--a);color:#fff;}.btn-g:hover{opacity:.85;}
.btn-d{background:transparent;color:var(--dn);border:1px solid rgba(229,57,53,.3);}.btn-d:hover{background:var(--dn);color:#fff;border-color:var(--dn);}
.btn-o{background:#ff8c00;color:#fff;}.btn-o:hover{opacity:.85;}
.btn-sm{padding:4px 9px;font-size:11px;}.btn-xs{padding:2px 7px;font-size:10px;}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
.g4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;}
.g5{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;}
@media(max-width:900px){.g4,.g5{grid-template-columns:1fr 1fr 1fr;}}
.fg{display:flex;flex-direction:column;gap:2px;}
.fl{display:flex;gap:5px;align-items:center;flex-wrap:wrap;}
table{width:100%;border-collapse:collapse;font-size:12px;}
th{text-align:left;padding:8px 7px;color:var(--m);font-weight:600;border-bottom:2px solid var(--bd);font-size:11px;white-space:nowrap;cursor:pointer;user-select:none;}
th:hover{color:var(--a);}
td{padding:7px 7px;border-bottom:1px solid var(--bd);vertical-align:middle;}
tbody tr:hover td{background:rgba(3,199,90,.03);}
.clickrow td{cursor:pointer;}
.mono{font-family:'DM Mono',monospace;font-size:11px;color:var(--m);}
.qpanel{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:12px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,.04);}
.qtitle{font-size:11px;font-weight:700;color:var(--a);text-transform:uppercase;letter-spacing:.4px;margin-bottom:8px;}
.empty{text-align:center;padding:24px;color:var(--m);}
.empty-icon{font-size:24px;margin-bottom:4px;}.empty-text{font-size:11px;}
.abar{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;flex-wrap:wrap;gap:5px;}
.fbar{display:flex;gap:3px;flex-wrap:wrap;margin-bottom:6px;}
.fbtn{padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid var(--bd);background:#fff;color:var(--m);transition:all .15s;font-family:inherit;}
.fbtn:hover{border-color:var(--a);color:var(--a);}
.fbtn.on{background:var(--a);border-color:var(--a);color:#fff;}
.notice{font-size:11px;padding:5px 9px;border-radius:8px;margin-bottom:7px;border-left:3px solid;}
.n-i{background:rgba(3,199,90,.07);border-color:var(--a);color:#00874a;}
.n-ok{background:rgba(0,185,107,.07);border-color:var(--a2);color:var(--a2);}
.n-w{background:rgba(247,201,72,.1);border-color:var(--a3);color:#a07800;}
.infobox{font-size:11px;color:var(--m);padding:6px 9px;background:var(--sf2);border-radius:8px;border-left:3px solid var(--a3);line-height:1.6;margin-bottom:6px;}
a.bl{color:var(--a);text-decoration:none;font-size:11px;}a.bl:hover{text-decoration:underline;}
.toast{position:fixed;bottom:16px;right:16px;background:#fff;border:1px solid var(--bd);border-radius:12px;padding:8px 13px;font-size:12px;z-index:9999;opacity:0;transform:translateY(8px);transition:all .3s;pointer-events:none;max-width:300px;box-shadow:0 4px 16px rgba(0,0,0,.12);}
.toast.on{opacity:1;transform:translateY(0);}
.memo-list{display:flex;flex-direction:column;gap:2px;margin-bottom:5px;}
.memo-item{background:var(--sf2);border-radius:8px;padding:4px 8px;font-size:11px;display:flex;justify-content:space-between;align-items:flex-start;gap:6px;}
.memo-date{color:var(--m);font-size:10px;font-family:'DM Mono',monospace;}
.pager{display:flex;gap:3px;align-items:center;flex-wrap:wrap;margin-top:6px;}
.pager-btn{padding:2px 7px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid var(--bd);background:#fff;color:var(--m);font-family:inherit;transition:all .15s;}
.pager-btn.on,.pager-btn:hover{background:var(--a);border-color:var(--a);color:#fff;}
.overdue td{background:rgba(229,57,53,.04)!important;}
.sri{display:flex;justify-content:space-between;align-items:center;padding:7px 9px;border-bottom:1px solid var(--bd);font-size:12px;}
.sri:hover{background:rgba(3,199,90,.03);}
.xmark{color:var(--dn);font-size:11px;margin-left:3px;font-weight:700;}
.idx-badge{display:inline-block;padding:2px 6px;border-radius:6px;font-size:10px;font-weight:700;font-family:'DM Mono',monospace;}
.st-badge{display:inline-block;padding:2px 7px;border-radius:20px;font-size:10px;font-weight:600;background:#f1f3f5;color:#555;}
.mail-edit{background:#fff;border:1px solid var(--bd);border-radius:8px;padding:10px;font-size:12px;line-height:1.9;color:var(--t);width:100%;min-height:240px;resize:vertical;font-family:'Noto Sans KR',sans-serif;}
.tmpl-tabs{display:flex;gap:4px;margin-bottom:8px;flex-wrap:wrap;}
.tb{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:600;cursor:pointer;border:2px solid var(--bd);background:#fff;color:var(--m);transition:all .15s;font-family:inherit;}
.tb.on{border-color:var(--a);background:rgba(3,199,90,.08);color:var(--a);}
.check-all-row{display:flex;align-items:center;gap:8px;padding:6px 10px;border-bottom:1px solid var(--bd);font-size:11px;font-weight:600;color:var(--m);background:var(--sf2);}
.check-bl-list{max-height:240px;overflow-y:auto;border:1px solid var(--bd);border-radius:8px;}
.check-bl-item{display:flex;align-items:center;gap:8px;padding:6px 10px;border-bottom:1px solid rgba(224,228,232,.5);font-size:12px;cursor:pointer;}
.check-bl-item:hover{background:rgba(3,199,90,.03);}
.check-bl-item input[type=checkbox]{width:14px;height:14px;accent-color:var(--a);}
.greeting-chip{display:inline-flex;align-items:center;gap:4px;background:#fff;border:1px solid var(--bd);border-radius:8px;padding:3px 8px;font-size:11px;cursor:pointer;transition:all .15s;}
.greeting-chip:hover{border-color:var(--a);color:var(--a);}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;}
.cal-day-name{text-align:center;font-size:11px;color:var(--m);padding:6px 0;font-weight:700;}
.cal-day{min-height:72px;background:#fff;border-radius:12px;padding:6px;font-size:11px;border:1px solid var(--bd);cursor:pointer;transition:all .2s;box-shadow:0 1px 3px rgba(0,0,0,.04);}
.cal-day:hover{border-color:var(--a);box-shadow:0 2px 8px rgba(3,199,90,.15);}
.cal-day.today{border-color:var(--a);background:rgba(3,199,90,.05);box-shadow:0 2px 8px rgba(3,199,90,.2);}
.cal-day.other-month{opacity:.35;box-shadow:none;}
.cal-day-num{font-weight:700;margin-bottom:3px;font-size:12px;}
.cal-day.today .cal-day-num{color:var(--a);}
.cal-event{border-radius:8px;padding:2px 5px;font-size:9px;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#fff;font-weight:600;}
.cal-event.visit{background:var(--a);color:#fff;}
.cal-event.contract{background:var(--a3);color:#5a4000;}
.cal-event.custom{background:var(--end);}
.cal-nav{display:flex;align-items:center;gap:10px;margin-bottom:14px;}
.cal-nav button{padding:5px 14px;border-radius:20px;font-size:12px;cursor:pointer;border:1px solid var(--bd);background:#fff;color:var(--t);font-family:inherit;transition:all .15s;font-weight:600;}
.cal-nav button:hover{border-color:var(--a);color:var(--a);background:rgba(3,199,90,.05);}
.cal-title{font-size:16px;font-weight:700;flex:1;text-align:center;color:var(--t);}
.kw-item{background:#fff;border:1px solid var(--bd);border-radius:10px;padding:9px 11px;margin-bottom:6px;cursor:pointer;transition:all .15s;}
.kw-item:hover,.kw-item.selected{border-color:var(--a);}
.kw-item.selected{background:rgba(3,199,90,.05);}
.kw-name{font-size:13px;font-weight:600;margin-bottom:3px;}
.kw-meta{font-size:11px;color:var(--m);}
.prog-biz-hdr{display:flex;align-items:center;justify-content:space-between;padding:10px 13px;background:#fff;border:1px solid var(--bd);border-radius:10px 10px 0 0;cursor:pointer;}
.prog-biz-hdr:hover{background:rgba(3,199,90,.03);}
.prog-biz-body{border:1px solid var(--bd);border-top:none;border-radius:0 0 10px 10px;overflow:hidden;}
.prog-st-bar{display:flex;gap:3px;flex-wrap:wrap;padding:6px 9px;background:var(--sf2);border-bottom:1px solid var(--bd);}
#loading{position:fixed;inset:0;background:rgba(248,249,250,.9);z-index:9998;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px;}
#loading.hide{display:none;}
.spinner{width:36px;height:36px;border:3px solid var(--bd);border-top:3px solid var(--a);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
#login-screen{position:fixed;inset:0;background:linear-gradient(135deg,#f0faf4 0%,#fff 100%);z-index:9999;display:flex;align-items:center;justify-content:center;}
#login-screen.hide{display:none;}
.login-box{background:#fff;border:1px solid var(--bd);border-radius:16px;padding:40px 36px;width:340px;display:flex;flex-direction:column;gap:16px;box-shadow:0 8px 32px rgba(0,0,0,.08);}
.login-title{font-size:20px;font-weight:700;text-align:center;margin-bottom:4px;color:#1a1a1a;}.login-title span{color:var(--a);}
.login-sub{font-size:11px;color:var(--m);text-align:center;margin-top:-8px;}
.login-box input{width:100%;background:#f8f9fa;border:1px solid var(--bd);border-radius:10px;padding:11px 13px;color:var(--t);font-size:13px;font-family:inherit;}
.login-box input:focus{outline:none;border-color:var(--a);box-shadow:0 0 0 3px rgba(3,199,90,.1);}
.login-btn{width:100%;padding:12px;background:var(--a);color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;}
.login-btn:hover{background:var(--a2);}
.login-err{font-size:11px;color:var(--dn);text-align:center;min-height:16px;}
</style>
</head>
<body>
<div id="login-screen">
  <div class="login-box">
    <div class="login-title">ë§ˆì¸ì¦ˆ<span>ë§ˆì¼€íŒ…</span></div>
    <div class="login-sub">ë¸”ë¡œê·¸ ì²´í—˜ë‹¨ ê´€ë¦¬ ì‹œìŠ¤í…œ</div>
    <input type="email" id="login-email" placeholder="ì´ë©”ì¼" onkeydown="if(event.key==='Enter')doLogin()">
    <input type="password" id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" onkeydown="if(event.key==='Enter')doLogin()">
    <div class="login-err" id="login-err"></div>
    <button class="login-btn" onclick="doLogin()">ë¡œê·¸ì¸</button>
  </div>
</div>
<div id="loading"><div class="spinner"></div><div style="font-size:12px;color:var(--m);">Firebase ì—°ê²° ì¤‘...</div></div>
<div id="toast" class="toast"></div>
<header>
  <div class="logo">ë§ˆì¸ì¦ˆ<span>ë§ˆì¼€íŒ…</span><small>ë¸”ë¡œê·¸ ì²´í—˜ë‹¨ ê´€ë¦¬</small></div>
  <div class="fl"><span id="sync-dot" style="font-size:10px;color:var(--m);">â—</span><span style="font-family:'DM Mono',monospace;font-size:10px;color:var(--m);">v9.1</span><span id="login-user" style="font-size:11px;color:var(--m);margin-left:10px;"></span><button onclick="doLogout()" style="margin-left:8px;font-size:11px;background:none;border:1px solid var(--bd);color:var(--m);border-radius:5px;padding:3px 8px;cursor:pointer;">ë¡œê·¸ì•„ì›ƒ</button></div>
</header>
<div class="chrome-tabbar" id="ctbar"></div>
<div class="app-body" id="appbody"></div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIG - ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FB_CFG={
  apiKey:"AIzaSyA8KN-uDlQydPoThq8koHxYkQSrRiQWGQI",
  authDomain:"mindz-blogger.firebaseapp.com",
  projectId:"mindz-blogger",
  storageBucket:"mindz-blogger.firebasestorage.app",
  messagingSenderId:"266278944187",
  appId:"1:266278944187:web:90af2f4126e2ebe294d89e"
};
let db,auth;
try{firebase.initializeApp(FB_CFG);db=firebase.firestore();auth=firebase.auth();}catch(e){console.warn(e);}

// â•â•â•â• STATE â•â•â•â•
let NEWB=[],EXISTB=[],BIZ=[],BIZB=[],KWDS=[],CALEVENTS=[];
let mailGreetings=JSON.parse(localStorage.getItem('mm_greet')||'[]');
let progressFilters={};
let recState={};
const PER=20;
const STATUSES=['ì‹ ê·œ','ìˆ˜ë½','ê±°ì ˆ','êµ¬ê¸€í¼ìš”ì²­','ì˜ˆì•½ì•ˆë‚´','ì¼ì •ì¡°ìœ¨','ì¼ì •í™•ì •','ë°©ë¬¸','ì™„ë£Œ','ì¢…ë£Œ'];
const IDX_LIST=['ì¤€ìµœ1','ì¤€ìµœ2','ì¤€ìµœ3','ì¤€ìµœ4','ì¤€ìµœ5','ì¤€ìµœ6','ìµœì 1','ìµœì 2','ìµœì 3'];
const PAGE_DEFS=[
  {k:'nb',l:'ì‹ ê·œ ë¸”ë¡œê±°'},{k:'eb',l:'ê¸°ì¡´ ë¸”ë¡œê±°'},{k:'biz4',l:'ì—…ì²´ë³„ ë¸”ë¡œê±°'},
  {k:'mail',l:'ë©”ì¼ ì‘ì„±'},{k:'prog',l:'ì§„í–‰ í˜„í™©'},{k:'excel',l:'ì—‘ì…€ ë‚´ë³´ë‚´ê¸°'},
  {k:'cal',l:'ì¼ì • ê´€ë¦¬'},{k:'bizm',l:'ì—…ì²´ ê´€ë¦¬'},{k:'kwm',l:'í‚¤ì›Œë“œ ê´€ë¦¬'},
  {k:'kwrec',l:'í‚¤ì›Œë“œ ì¶”ì²œ'},{k:'set',l:'âš™ ì„¤ì •'},
];

// â•â•â•â• CHROME TAB + PANEL SYSTEM â•â•â•â•
let panels=[];
let panelCounter=0;

function addPanel(pageKey){
  const id='p'+(++panelCounter);
  panels.push({id,pageKey});
  renderChromeTabBar();
  renderAppBody();
  return id;
}

function removePanel(id){
  if(panels.length<=1){toast('ìµœì†Œ 1ê°œ íŒ¨ë„ í•„ìš”','var(--a3)');return;}
  panels=panels.filter(p=>p.id!==id);
  renderChromeTabBar();renderAppBody();
}

function setPanelPage(id,pageKey){
  const p=panels.find(p=>p.id===id);if(!p)return;
  p.pageKey=pageKey;
  renderChromeTabBar();renderAppBody();
}

function renderChromeTabBar(){
  const bar=E('ctbar');if(!bar)return;
  bar.innerHTML=panels.map((p,i)=>{
    const def=PAGE_DEFS.find(d=>d.k===p.pageKey)||{l:p.pageKey};
    return`<div class="ct${i===0?' active':''}" onclick="ctClick(this)" data-pid="${p.id}">
      <span class="ct-label">${def.l}</span>
      <button class="ct-x" onclick="event.stopPropagation();removePanel('${p.id}')" title="ë‹«ê¸°">Ã—</button>
    </div>`;
  }).join('')+`<button class="ct-add" onclick="addPanel('nb')" title="ìƒˆ íŒ¨ë„ ì¶”ê°€">+</button>`;
}

function ctClick(tab){
  document.querySelectorAll('.ct').forEach(t=>t.classList.remove('active'));
  tab.classList.add('active');
  const pid=tab.dataset.pid;
  const el=E(pid);if(el)el.scrollIntoView({behavior:'smooth',inline:'nearest'});
}

function renderAppBody(){
  const body=E('appbody');if(!body)return;
  body.innerHTML=panels.map(p=>buildPanelHTML(p)).join('');
  panels.forEach(p=>setTimeout(()=>onPageInit(p.id,p.pageKey),10));
}

function buildPanelHTML({id,pageKey}){
  const showClose=panels.length>1;
  const navTabs=PAGE_DEFS.map(d=>`<button class="pnav-tab${d.k===pageKey?' active':''}" onclick="setPanelPage('${id}','${d.k}')">${d.l}</button>`).join('');
  return`<div class="panel" id="${id}">
    <div class="panel-nav">${navTabs}${showClose?`<button class="panel-close" onclick="removePanel('${id}')">âœ•</button>`:''}</div>
    <div class="panel-content" id="c_${id}">${getPageHTML(pageKey,id)}</div>
  </div>`;
}

function onPageInit(pid,pageKey){
  if(pageKey==='nb')initNB(pid);
  else if(pageKey==='eb')initEB(pid);
  else if(pageKey==='biz4')initBiz4(pid);
  else if(pageKey==='mail'){fillMailBizSel(pid);genMail(pid);fillGreetingList(pid);}
  else if(pageKey==='prog')renderProgress(pid);
  else if(pageKey==='excel')initExcel(pid);
  else if(pageKey==='cal')renderCal(pid);
  else if(pageKey==='bizm')renderBizM(pid);
  else if(pageKey==='kwm')initKwm(pid);
  else if(pageKey==='kwrec')initKwrec(pid);
  else if(pageKey==='set')renderSettings(pid);
}

// â•â•â•â• UTILS â•â•â•â•
let _tm;
function toast(msg,col){clearTimeout(_tm);const t=E('toast');t.textContent=msg;t.style.borderLeft='3px solid '+(col||'var(--a2)');t.classList.add('on');_tm=setTimeout(()=>t.classList.remove('on'),3200);}
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,5);}
function E(id){return document.getElementById(id);}
function ss(v){return v==null?'':String(v);}
function x(s){return ss(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
const ISO=()=>new Date().toISOString().slice(0,10);
const KRD=()=>new Date().toLocaleDateString('ko-KR');
function monthsDiff(s){if(!s)return 0;const d=new Date(s),n=new Date();return(n.getFullYear()-d.getFullYear())*12+n.getMonth()-d.getMonth();}
function pE(pid,base){const c=E('c_'+pid);return c?c.querySelector('#'+pid+'_'+base):null;}
function pG(pid,base){const el=pE(pid,base);return el?el.value.trim():'';}
function pS(pid,base,v){const el=pE(pid,base);if(el)el.value=ss(v);}
function mk(pid,base){return pid+'_'+base;}
function dcsv(h,rows,f){const csv=[h,...rows].map(r=>r.map(v=>'"'+ss(v).replace(/"/g,'""')+'"').join(',')).join('\r\n');const a=document.createElement('a');a.href='data:text/csv;charset=utf-8,'+encodeURIComponent('\uFEFF'+csv);a.download=f;a.style.display='none';document.body.appendChild(a);a.click();setTimeout(()=>document.body.removeChild(a),100);}
function copyText(t){return new Promise((ok,fail)=>{if(navigator.clipboard&&window.isSecureContext){navigator.clipboard.writeText(t).then(ok).catch(()=>fb());}else fb();function fb(){const ta=document.createElement('textarea');ta.value=t;ta.style.cssText='position:fixed;left:-9999px;';document.body.appendChild(ta);ta.focus();ta.select();try{document.execCommand('copy');document.body.removeChild(ta);ok();}catch(e){document.body.removeChild(ta);fail(e);}}});}
function renderPager(cid,page,total,fnStr){const tp=Math.ceil(total/PER)||1,el=E(cid);if(!el)return;if(tp<=1){el.innerHTML='';return;}el.innerHTML=`<span style="font-size:10px;color:var(--m);margin-right:3px;">${total}ëª…</span>`+Array.from({length:tp},(_,i)=>i+1).map(i=>`<button class="pager-btn${i===page?' on':''}" onclick="(${fnStr})(${i})">${i}</button>`).join('');}
function idxRank(idx){const i=IDX_LIST.indexOf(idx);return i>=0?i:99;}
const ST_COLOR={'ì‹ ê·œ':'#e8f5e9;color:#2e7d32','ìˆ˜ë½':'#e3f2fd;color:#1565c0','ê±°ì ˆ':'#ffebee;color:#c62828','êµ¬ê¸€í¼ìš”ì²­':'#fff8e1;color:#f57f17','ì˜ˆì•½ì•ˆë‚´':'#f3e5f5;color:#7b1fa2','ì¼ì •ì¡°ìœ¨':'#fce4ec;color:#c2185b','ì¼ì •í™•ì •':'#e0f2f1;color:#00695c','ë°©ë¬¸':'#e8f5e9;color:#1b5e20','ì™„ë£Œ':'#e8eaf6;color:#283593','ì¢…ë£Œ':'#f5f5f5;color:#616161'};
function stBadge(st){const c=ST_COLOR[st]||'#f1f3f5;color:#555';return`<span class="st-badge" style="background:${c.split(';')[0]};${c.split(';')[1]||''}">${x(st)}</span>`;}
function idxBadge(idx){if(!idx)return`<span style="color:var(--m)">-</span>`;const isJ=idx.startsWith('ì¤€ìµœ');const gr=parseInt(idx.slice(2))||1;const mx=isJ?6:3;const ratio=gr/mx;if(isJ){const g=Math.round(220-ratio*80);return`<span class="idx-badge" style="background:hsl(38,90%,${55+ratio*10}%);color:#5a3a00;">${idx}</span>`;}else{const l=Math.round(42+ratio*18);return`<span class="idx-badge" style="background:hsl(145,60%,${l}%);color:#fff;">${idx}</span>`;}}
function fillIdxSel(pid,base,val){const el=pE(pid,base)||E(mk(pid,base));if(!el)return;el.innerHTML='<option value="">ì„ íƒ</option>'+IDX_LIST.map(v=>`<option value="${v}"${v===val?' selected':''}>${v}</option>`).join('');}
function parseCSVLine(line){const res=[];let cur='',q=false;for(let i=0;i<line.length;i++){const c=line[i];if(c==='"'){if(q&&line[i+1]==='"'){cur+='"';i++;}else q=!q;}else if(c===','&&!q){res.push(cur.trim());cur='';}else cur+=c;}res.push(cur.trim());return res;}
function fillAllBizSels(){
  document.querySelectorAll('[id$="_bizsel"]').forEach(sel=>{const cur=sel.value;sel.innerHTML='<option value="">-- ì—…ì²´ ì„ íƒ --</option>'+BIZ.map(b=>`<option value="${b.id}">${x(b.name)}</option>`).join('');if(cur)sel.value=cur;});
  document.querySelectorAll('[id$="_excel_bizlist"]').forEach(el=>{const pid=el.id.replace('_excel_bizlist','');const prev=[...el.querySelectorAll('input:checked')].map(i=>i.value);el.innerHTML=BIZ.map(b=>`<label class="check-bl-item"><input type="checkbox" value="${b.id}"${prev.includes(b.id)?' checked':''} onchange="updateExcelPreview('${pid}')"><span>${x(b.name)}</span></label>`).join('');});
}

// â•â•â•â• FIREBASE â•â•â•â•
async function fsSet(col,id,data){if(!db)return;await db.collection(col).doc(id).set(data,{merge:true});}
async function fsAdd(col,data){if(!db)return uid();const r=await db.collection(col).add(data);return r.id;}
async function fsDel(col,id){if(!db)return;await db.collection(col).doc(id).delete();}
async function fsUpd(col,id,data){if(!db)return;await db.collection(col).doc(id).update(data);}

function startListeners(){
  if(!db){
    E('sync-dot').style.color='var(--dn)';
    E('loading').classList.add('hide');
    addPanel('nb');
    return;
  }
  let n=0;
  const done=()=>{if(++n===5){E('loading').classList.add('hide');addPanel('nb');}};
  db.collection('newBloggers').onSnapshot(s=>{NEWB=s.docs.map(d=>({id:d.id,...d.data()}));panels.forEach(p=>{if(p.pageKey==='nb')initNB(p.id);});done();},()=>done());
  db.collection('existingBloggers').onSnapshot(s=>{EXISTB=s.docs.map(d=>({id:d.id,...d.data()}));panels.forEach(p=>{if(p.pageKey==='eb')initEB(p.id);});done();},()=>done());
  db.collection('businesses').onSnapshot(s=>{BIZ=s.docs.map(d=>({id:d.id,...d.data()}));fillAllBizSels();panels.forEach(p=>{if(p.pageKey==='bizm')renderBizM(p.id);});done();},()=>done());
  db.collection('bizBloggers').onSnapshot(s=>{BIZB=s.docs.map(d=>({id:d.id,...d.data()}));panels.forEach(p=>{if(p.pageKey==='biz4')renderBiz4List(p.id);if(p.pageKey==='prog')renderProgress(p.id);});done();},()=>done());
  db.collection('keywords').onSnapshot(s=>{KWDS=s.docs.map(d=>({id:d.id,...d.data()}));done();},()=>done());
  db.collection('calEvents').onSnapshot(s=>{CALEVENTS=s.docs.map(d=>({id:d.id,...d.data()}));panels.forEach(p=>{if(p.pageKey==='cal')renderCal(p.id);});});
  E('sync-dot').style.color='var(--a2)';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAGE HTML GENERATORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getPageHTML(k,pid){
  if(k==='nb')return nbHTML(pid);
  if(k==='eb')return ebHTML(pid);
  if(k==='biz4')return biz4HTML(pid);
  if(k==='mail')return mailHTML(pid);
  if(k==='prog')return progHTML(pid);
  if(k==='excel')return excelHTML(pid);
  if(k==='cal')return calHTML(pid);
  if(k==='bizm')return bizmHTML(pid);
  if(k==='kwm')return kwmHTML(pid);
  if(k==='kwrec')return kwrecHTML(pid);
  if(k==='set')return setHTML(pid);
  return'<div class="empty">ì¤€ë¹„ ì¤‘</div>';
}

function nbHTML(pid){const p=pid+'_';return`
<div class="stitle">ì‹ ê·œ ë¸”ë¡œê±° ë¦¬ìŠ¤íŠ¸ì—…</div><div class="ssub">ìƒˆ ë¸”ë¡œê±° ì •ë³´ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.</div>
<div class="qpanel">
  <div class="qtitle" id="${p}nb_ftitle">âš¡ ë¸”ë¡œê±° ì¶”ê°€</div>
  <input type="hidden" id="${p}nb_id">
  <div class="g4" style="margin-bottom:7px;">
    <div class="fg"><label class="lbl">ë‹‰ë„¤ì„ *</label><input id="${p}nb_nick" placeholder="ë¸”ë¡œê±° ë‹‰ë„¤ì„"></div>
    <div class="fg"><label class="lbl">ì´ë©”ì¼</label><input id="${p}nb_email" type="email"></div>
    <div class="fg"><label class="lbl">ë¸”ë¡œê·¸ ì£¼ì†Œ</label><input id="${p}nb_url" placeholder="https://blog.naver.com/..."></div>
    <div class="fg"><label class="lbl">IDX</label><select id="${p}nb_idx"><option value="">ì„ íƒ</option></select></div>
    
  </div>
  <div class="g3" style="margin-bottom:7px;">
    <div class="fg"><label class="lbl">RK</label><input id="${p}nb_rk"></div>
    <div class="fg"><label class="lbl">ê²€ìƒ‰ì–´</label><input id="${p}nb_kw"></div>
    <div class="fg"><label class="lbl">ê²€ìƒ‰ì–´ ì‚¬ì´ì¦ˆ</label><input id="${p}nb_kws"></div>
  </div>
  <div class="fg" style="margin-bottom:7px;">
    <label class="lbl">ë©”ëª¨</label>
    <div class="fl"><input id="${p}nb_mnew" placeholder="ë©”ëª¨ ë‚´ìš©" style="flex:1;" onkeydown="if(event.key==='Enter'){event.preventDefault();nbAddMemo('${pid}');}"><button class="btn btn-s btn-sm" onclick="nbAddMemo('${pid}')">ì¶”ê°€</button></div>
  </div>
  <div id="${p}nb_mlist" class="memo-list"></div>
  <div style="display:flex;justify-content:flex-end;gap:6px;">
    <button class="btn btn-s btn-sm" onclick="nbCancel('${pid}')">ì´ˆê¸°í™”</button>
    <button class="btn btn-g" id="${p}nb_savebtn" onclick="nbSave('${pid}')">+ ì¶”ê°€</button>
  </div>
</div>
<div class="card">
  <div class="abar">
    <div><div class="ctitle">ì‹ ê·œ ë¸”ë¡œê±° ëª©ë¡</div><span id="${p}nb_count" class="mono">0ëª…</span></div>
    <div class="fl"><input id="${p}nb_srch" placeholder="ğŸ” ê²€ìƒ‰" style="width:130px;font-size:11px;" oninput="renderNB('${pid}')">
    <button class="btn btn-s btn-sm" onclick="sortNB('${pid}','idx')">IDXì •ë ¬</button>
    <button class="btn btn-s btn-sm" onclick="sortNB('${pid}','rk')">RKì •ë ¬</button>
    </div>
  </div>
  <div style="overflow-x:auto;"><table>
    <thead><tr><th onclick="sortNB('${pid}','nick')">ë‹‰ë„¤ì„</th><th>ì´ë©”ì¼</th><th>ë¸”ë¡œê·¸</th><th onclick="sortNB('${pid}','idx')">IDX</th><th onclick="sortNB('${pid}','rk')">RK</th><th>ê²€ìƒ‰ì–´</th><th>ì‚¬ì´ì¦ˆ</th><th>ë©”ëª¨</th><th>ìˆ˜ì •/ì‚­ì œ</th></tr></thead>
    <tbody id="${p}nb_tbody"></tbody>
  </table></div>
  <div id="${p}nb_pager" class="pager"></div>
</div>`;}

function ebHTML(pid){const p=pid+'_';return`
<div class="stitle">ê¸°ì¡´ ë¸”ë¡œê±° ë¦¬ìŠ¤íŠ¸ì—…</div><div class="ssub">ê²€ìƒ‰: +í¬í•¨ë‹¨ì–´ -ì œì™¸ë‹¨ì–´</div>
<div class="card">
  <div class="abar">
    <div><div class="ctitle">ê¸°ì¡´ ë¸”ë¡œê±° ëª©ë¡</div><span id="${p}eb_count" class="mono">0ëª…</span></div>
    <div class="fl"><input id="${p}eb_srch" placeholder="ğŸ” +í¬í•¨ -ì œì™¸" style="width:150px;font-size:11px;" oninput="renderEB('${pid}')"><button class="btn btn-s btn-sm" onclick="expEB()">CSV</button></div>
  </div>
  <div style="overflow-x:auto;"><table>
    <thead><tr><th onclick="sortEB('${pid}','nick')">ë‹‰ë„¤ì„</th><th>ì´ë¦„</th><th>ì´ë©”ì¼</th><th>ë¸”ë¡œê·¸</th><th onclick="sortEB('${pid}','idx')">IDX</th><th onclick="sortEB('${pid}','rk')">RK</th><th onclick="sortEB('${pid}','lv')">LV</th><th onclick="sortEB('${pid}','rank')">ìˆœìœ„</th><th onclick="sortEB('${pid}','sc')">SC</th></tr></thead>
    <tbody id="${p}eb_tbody"></tbody>
  </table></div>
  <div id="${p}eb_pager" class="pager"></div>
</div>
<div class="qpanel" id="${p}eb_editpanel" style="display:none;">
  <div class="qtitle">âœï¸ ê¸°ì¡´ ë¸”ë¡œê±° ìˆ˜ì •</div>
  <input type="hidden" id="${p}eb_id">
  <div class="g3" style="margin-bottom:7px;">
    <div class="fg"><label class="lbl">ë‹‰ë„¤ì„</label><input id="${p}eb_nick"></div>
    <div class="fg"><label class="lbl">ì´ë¦„</label><input id="${p}eb_name"></div>
    <div class="fg"><label class="lbl">ì´ë©”ì¼</label><input id="${p}eb_email"></div>
  </div>
  <div class="g2" style="margin-bottom:7px;">
    <div class="fg"><label class="lbl">ë¸”ë¡œê·¸ ì£¼ì†Œ</label><input id="${p}eb_url"></div>
    <div class="fg"><label class="lbl">ì—°ë½ì²˜</label><input id="${p}eb_phone"></div>
  </div>
  <div class="g5" style="margin-bottom:7px;">
    <div class="fg"><label class="lbl">IDX</label><select id="${p}eb_idx"><option value="">ì„ íƒ</option></select></div>
    <div class="fg"><label class="lbl">RK</label><input id="${p}eb_rk"></div>
    <div class="fg"><label class="lbl">LV</label><input id="${p}eb_lv"></div>
    <div class="fg"><label class="lbl">ìˆœìœ„</label><input id="${p}eb_rank"></div>
    <div class="fg"><label class="lbl">SC</label><input id="${p}eb_sc"></div>
  </div>
  <div class="g2" style="margin-bottom:7px;">
    <div class="fg"><label class="lbl">ê³„ì¢Œë²ˆí˜¸</label><input id="${p}eb_acct"></div>
    <div class="fg"><label class="lbl">ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸</label><input id="${p}eb_ssn"></div>
  </div>
  <div class="g3" style="margin-bottom:7px;">
    <div class="fg"><label class="lbl">ì œì™¸ ì§€ì—­</label><input id="${p}eb_excl"></div>
    <div class="fg"><label class="lbl">ì •ë³´ìˆ˜ì§‘ì¼</label><input type="date" id="${p}eb_coldate"></div>
    <div class="fg"><label class="lbl">ì •ë³´íŒŒê¸°ì¼</label><input type="date" id="${p}eb_expdate"></div>
  </div>
  <div class="fg" style="margin-bottom:7px;">
    <label class="lbl">ë©”ëª¨</label>
    <div class="fl"><input id="${p}eb_mnew" placeholder="ë©”ëª¨ ì¶”ê°€" style="flex:1;" onkeydown="if(event.key==='Enter'){event.preventDefault();ebAddMemo('${pid}');}"><button class="btn btn-s btn-sm" onclick="ebAddMemo('${pid}')">ì¶”ê°€</button></div>
    <div id="${p}eb_mlist" class="memo-list" style="margin-top:4px;"></div>
  </div>
  <div class="fg" style="margin-bottom:7px;">
    <label class="lbl">ê³¼ê±° ì²´í—˜ë‹¨ ë‚´ì—­</label>
    <div id="${p}eb_history" style="font-size:11px;color:var(--m);">ì—†ìŒ</div>
  </div>
  <div style="display:flex;justify-content:flex-end;gap:6px;">
    <button class="btn btn-s btn-sm" onclick="ebCloseEdit('${pid}')">ì·¨ì†Œ</button>
    <button class="btn btn-g" onclick="ebSave('${pid}')">ì €ì¥</button>
  </div>
</div>`;}

function biz4HTML(pid){const p=pid+'_';return`
<div class="stitle">ì—…ì²´ë³„ ë¸”ë¡œê±° ë¦¬ìŠ¤íŠ¸ì—…</div><div class="ssub">ì—…ì²´ë¥¼ ì„ íƒí•˜ê³  ë¸”ë¡œê±°ë¥¼ ì¶”ê°€Â·ê´€ë¦¬í•©ë‹ˆë‹¤.</div>
<div class="card" style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap;">
  <div class="fg" style="min-width:180px;flex:1;"><label class="lbl">ì—…ì²´ ì„ íƒ</label><select id="${p}bizsel" class="biz4_bizsel_${pid}" onchange="biz4Change('${pid}')"><option value="">-- ì—…ì²´ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option></select></div>
  <div class="fl" style="flex-wrap:wrap;gap:5px;padding-bottom:1px;">
    <button class="btn btn-g btn-sm" onclick="biz4ToggleAdd('${pid}')">+ ë¸”ë¡œê±° ì¶”ê°€</button>
    <button class="btn btn-s btn-sm" onclick="biz4ToggleGForm('${pid}')">ğŸ“‹ êµ¬ê¸€í¼ CSV</button>
  </div>
</div>
<div class="qpanel" id="${p}biz4_addpanel" style="display:none;">
  <div class="qtitle">+ ë¸”ë¡œê±° ì¶”ê°€</div>
  <input id="${p}biz4_srch" placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰..." style="margin-bottom:7px;" oninput="biz4SearchB('${pid}')">
  <div id="${p}biz4_results" style="border:1px solid var(--bd);border-radius:7px;max-height:260px;overflow-y:auto;"></div>
  <div style="display:flex;justify-content:flex-end;margin-top:7px;"><button class="btn btn-s btn-sm" onclick="biz4ToggleAdd('${pid}')">ë‹«ê¸°</button></div>
</div>
<div class="qpanel" id="${p}biz4_gformpanel" style="display:none;">
  <div class="qtitle">ğŸ“‹ êµ¬ê¸€í¼ CSV ë§¤ì¹­</div>
  <div class="infobox">ì»¬ëŸ¼: A:íƒ€ì„ìŠ¤íƒ¬í”„ | B:ì´ë¦„ | C:ë‹‰ë„¤ì„ | D:ì—°ë½ì²˜ | E:ì´ë©”ì¼ | F:ë¸”ë¡œê·¸ì£¼ì†Œ</div>
  <div style="border:2px dashed var(--bd);border-radius:7px;padding:10px;text-align:center;cursor:pointer;margin-bottom:7px;color:var(--m);font-size:11px;" onclick="E('${p}gform_file').click()">ğŸ“‚ CSV íŒŒì¼ ì„ íƒ<input type="file" id="${p}gform_file" accept=".csv,.txt" style="display:none" onchange="gformCSVFile('${pid}')"></div>
  <div class="fg" style="margin-bottom:7px;"><label class="lbl">ë˜ëŠ” CSV ë¶™ì—¬ë„£ê¸°</label><textarea id="${p}gform_paste" rows="3"></textarea></div>
  <div id="${p}gform_result" style="font-size:11px;color:var(--a2);min-height:14px;margin-bottom:7px;"></div>
  <div style="display:flex;justify-content:flex-end;gap:6px;">
    <button class="btn btn-s btn-sm" onclick="biz4ToggleGForm('${pid}')">ë‹«ê¸°</button>
    <button class="btn btn-g btn-sm" onclick="importGFormCSV('${pid}')">ë§¤ì¹­ ì‹¤í–‰</button>
  </div>
</div>
<div class="card">
  <div class="abar">
    <div class="ctitle" style="margin:0;" id="${p}biz4_title">ì—…ì²´ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
    <div class="fl" style="flex-wrap:wrap;gap:4px;">
      <div class="fbar" id="${p}biz4_filterbar" style="margin:0;"></div>
      <button class="btn btn-s btn-sm" onclick="expBiz4('${pid}')">CSV</button>
    </div>
  </div>
  <div style="overflow-x:auto;"><table>
    <thead><tr><th>ë‹‰ë„¤ì„</th><th>ì´ë¦„</th><th>ì—°ë½ì²˜</th><th>IDX</th><th>RK</th><th>ìƒíƒœ</th><th>ë°©ë¬¸ì¼</th><th>í¬ìŠ¤íŒ…ê¸°í•œ</th><th>í¬ìŠ¤íŒ…</th><th>ì‚­ì œ</th></tr></thead>
    <tbody id="${p}biz4_tbody"></tbody>
  </table></div>
  <div id="${p}biz4_pager" class="pager"></div>
</div>
<div class="qpanel" id="${p}b4_infopanel" style="display:none;">
  <div class="qtitle">âœ… ë¸”ë¡œê±° ì •ë³´ í¸ì§‘</div>
  <input type="hidden" id="${p}b4_eid">
  <div class="g5" style="margin-bottom:7px;">
    <div class="fg"><label class="lbl">ì´ë¦„</label><input id="${p}b4_name"></div>
    <div class="fg"><label class="lbl">ì—°ë½ì²˜</label><input id="${p}b4_phone"></div>
    <div class="fg"><label class="lbl">ë°©ë¬¸ ë‚ ì§œ</label><input type="date" id="${p}b4_vdate"></div>
    <div class="fg"><label class="lbl">ë°©ë¬¸ ì‹œê°„</label><input id="${p}b4_vtime" placeholder="18:00"></div>
    <div class="fg"><label class="lbl">í¬ìŠ¤íŒ… ê¸°í•œ</label><input type="date" id="${p}b4_pdeadline"></div>
  </div>
  <div class="g2" style="margin-bottom:7px;">
    <div class="fg"><label class="lbl">í¬ìŠ¤íŒ… URL</label><input id="${p}b4_purl"></div>
    <div class="fg"><label class="lbl">ë¹„ê³ </label><input id="${p}b4_note"></div>
  </div>
  <div style="display:flex;justify-content:flex-end;gap:6px;">
    <button class="btn btn-s btn-sm" onclick="pE('${pid}','b4_infopanel').style.display='none'">ë‹«ê¸°</button>
    <button class="btn btn-g" onclick="saveB4Info('${pid}')">ì €ì¥</button>
  </div>
</div>
<div class="qpanel" id="${p}b4_rejpanel" style="display:none;">
  <div class="qtitle" style="color:var(--dn);">âŒ ê±°ì ˆ ì‚¬ìœ  ì…ë ¥</div>
  <input type="hidden" id="${p}b4_rejeid">
  <div class="fg" style="margin-bottom:7px;"><label class="lbl">ê±°ì ˆ ì‚¬ìœ </label><textarea id="${p}b4_rejreason" rows="2"></textarea></div>
  <div style="display:flex;justify-content:flex-end;gap:6px;">
    <button class="btn btn-s btn-sm" onclick="pE('${pid}','b4_rejpanel').style.display='none'">ì·¨ì†Œ</button>
    <button class="btn btn-d" onclick="saveB4Reject('${pid}')">ì €ì¥</button>
  </div>
</div>
<div class="qpanel" id="${p}b4_paypanel" style="display:none;">
  <div class="qtitle" style="color:var(--a3);">ğŸ’³ ì…ê¸ˆì²˜ ë° ì‹ ë¶„ì¦ ì •ë³´</div>
  <input type="hidden" id="${p}b4_payeid">
  <div class="g2" style="margin-bottom:7px;">
    <div class="fg"><label class="lbl">ê³„ì¢Œë²ˆí˜¸</label><input id="${p}b4_payacct"></div>
    <div class="fg"><label class="lbl">ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸</label><input id="${p}b4_payssn"></div>
  </div>
  <div style="display:flex;justify-content:flex-end;gap:6px;">
    <button class="btn btn-s btn-sm" onclick="pE('${pid}','b4_paypanel').style.display='none'">ì·¨ì†Œ</button>
    <button class="btn btn-g" onclick="saveB4Payment('${pid}')">ì €ì¥ (â†’ì¢…ë£Œ)</button>
  </div>
</div>
<div class="qpanel" id="${p}b4_comppanel" style="display:none;">
  <div class="qtitle">ğŸ ì¢…ë£Œ ì²˜ë¦¬ â†’ ê¸°ì¡´ë¸”ë¡œê±° ê³¼ê±°ì²´í—˜ë‹¨ ì €ì¥</div>
  <input type="hidden" id="${p}b4_compeid">
  <div class="g3" style="margin-bottom:7px;">
    <div class="fg"><label class="lbl">ê²€ìƒ‰ì–´</label><input id="${p}b4_compkw"></div>
    <div class="fg"><label class="lbl">ê²€ìƒ‰ì–´ ì‚¬ì´ì¦ˆ</label><input id="${p}b4_compkws"></div>
    <div class="fg"><label class="lbl">ì¡°ê±´</label><input id="${p}b4_compcond"></div>
  </div>
  <div class="g2" style="margin-bottom:7px;">
    <div class="fg"><label class="lbl">ë°©ë¬¸ì¼</label><input type="date" id="${p}b4_compvisit"></div>
    <div class="fg"><label class="lbl">í¬ìŠ¤íŒ… URL</label><input id="${p}b4_compurl"></div>
  </div>
  <div style="display:flex;justify-content:flex-end;gap:6px;">
    <button class="btn btn-s btn-sm" onclick="pE('${pid}','b4_comppanel').style.display='none'">ì·¨ì†Œ</button>
    <button class="btn btn-o" onclick="doB4Complete('${pid}')">âœ“ ì €ì¥ â†’ ê¸°ì¡´ë¸”ë¡œê±° ì´ë™</button>
  </div>
</div>`;}

function mailHTML(pid){const p=pid+'_';return`
<div class="stitle">ë©”ì¼ ì‘ì„±</div><div class="ssub">ìƒí™© ì„ íƒ â†’ ë°›ëŠ” ì‚¬ëŒ ì²´í¬ â†’ ë„¤ì´ë²„ì›ìŠ¤ ì¼ê´„ ë°œì†¡</div>
<div class="g2">
  <div>
    <div class="card">
      <div class="ctitle">1. ìƒí™© ì„ íƒ</div>
      <div class="tmpl-tabs">
        <button class="tb on" onclick="selMailSit('${pid}',1)">ğŸ“¨ ì»¨í…</button>
        <button class="tb" onclick="selMailSit('${pid}',2)">âœ… êµ¬ê¸€í¼ ìš”ì²­</button>
        <button class="tb" onclick="selMailSit('${pid}',3)">ğŸ“… ì˜ˆì•½ ì•ˆë‚´</button>
        <button class="tb" onclick="selMailSit('${pid}',4)">ğŸ“ í¬ìŠ¤íŒ… ì™„ë£Œ í™•ì¸</button>
      </div>
      <div id="${p}mail_sitdesc" class="notice n-i" style="margin-bottom:0;">ëŒ€ìƒ: ìƒíƒœ "ì‹ ê·œ" ì¸ ë¸”ë¡œê±°</div>
    </div>
    <div class="card">
      <div class="ctitle">2. ë°›ëŠ” ì‚¬ëŒ ì„ íƒ</div>
      <div class="fg" style="margin-bottom:7px;"><label class="lbl">ì—…ì²´ ì„ íƒ</label><select id="${p}bizsel" onchange="mailBizChange('${pid}')"><option value="">-- ì—…ì²´ ì„ íƒ --</option></select></div>
      <div class="check-all-row">
        <input type="checkbox" id="${p}mail_checkall" onchange="toggleMailCheckAll('${pid}',this.checked)" style="width:14px;height:14px;accent-color:var(--a);">
        <label for="${p}mail_checkall" style="cursor:pointer;">ì „ì²´ ì„ íƒ</label>
        <span id="${p}mail_selcnt" style="margin-left:auto;color:var(--a);font-weight:700;"></span>
      </div>
      <div id="${p}mail_blist" class="check-bl-list"></div>
    </div>
    <div class="card">
      <div class="ctitle">3. ë©”ì¼ ì„¤ì •</div>
      <div class="fg" style="margin-bottom:7px;"><label class="lbl">ì œëª©</label><input id="${p}mail_subject" placeholder="ë©”ì¼ ì œëª©"></div>
      <div id="${p}mail_vars1">
        <div class="g2" style="margin-bottom:6px;">
          <div class="fg"><label class="lbl">ì§€ì—­</label><input id="${p}mv_reg" oninput="genMail('${pid}')"></div>
          <div class="fg"><label class="lbl">ìƒí˜¸ëª…</label><input id="${p}mv_store" oninput="genMail('${pid}')"></div>
        </div>
        <div class="g2" style="margin-bottom:6px;">
          <div class="fg"><label class="lbl">ììœ ì‹ì‚¬ê¶Œ(ë§Œì›)</label><input id="${p}mv_meal" type="number" oninput="genMail('${pid}')"></div>
          <div class="fg"><label class="lbl">ì›ê³ ë£Œ(ë§Œì›)</label><input id="${p}mv_fee" type="number" oninput="genMail('${pid}')"></div>
        </div>
        <div class="fg" style="margin-bottom:6px;"><label class="lbl">í”Œë ˆì´ìŠ¤ URL</label><input id="${p}mv_addr" oninput="genMail('${pid}')"></div>
        <div class="fg" style="margin-bottom:6px;"><label class="lbl">ë°©ë¬¸ ê°€ëŠ¥ ì¼ì</label><input id="${p}mv_visit" oninput="genMail('${pid}')"></div>
        <div class="fg" style="margin-bottom:6px;"><label class="lbl">ê³µí†µì‚¬í•­ â‘¡</label><input id="${p}mv_r2" oninput="genMail('${pid}')"></div>
        <div class="fg"><label class="lbl">ê³µí†µì‚¬í•­ â‘¢</label><input id="${p}mv_r3" oninput="genMail('${pid}')"></div>
      </div>
      <div id="${p}mail_vars2" style="display:none;">
        <div class="fg" style="margin-bottom:6px;"><label class="lbl">ë¬¸ì˜ ë‹µë³€</label><textarea id="${p}mv_qna" rows="2" oninput="genMail('${pid}')"></textarea></div>
        <div class="fg"><label class="lbl">êµ¬ê¸€í¼ ë§í¬</label><input id="${p}mv_form" oninput="genMail('${pid}')"></div>
      </div>
      <div id="${p}mail_vars3" style="display:none;">
        <div class="g2" style="margin-bottom:6px;">
          <div class="fg"><label class="lbl">ì˜ˆì•½ ë‚ ì§œ</label><input id="${p}mv_bookdate" oninput="genMail('${pid}')"></div>
          <div class="fg"><label class="lbl">ì˜ˆì•½ ì‹œê°„</label><input id="${p}mv_booktime" oninput="genMail('${pid}')"></div>
        </div>
      </div>
      <div id="${p}mail_vars4" style="display:none;"><div class="infobox">í¬ìŠ¤íŒ… ì™„ë£Œ í™•ì¸ ë©”ì¼ì…ë‹ˆë‹¤. ë³¸ë¬¸ ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥.</div></div>
      <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--bd);">
        <div class="ctitle" style="margin-bottom:5px;">ì¸ì‚¬ë§ ê´€ë¦¬</div>
        <div class="notice n-w" style="font-size:10px;">í´ë¦­í•˜ë©´ í˜„ì¬ ìƒí™©ì˜ ì¸ì‚¬ë§ ìœ„ì¹˜ì— ìë™ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤.</div>
        <div id="${p}greeting_list" style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:5px;"></div>
        <div class="fl">
          <input id="${p}greeting_new" placeholder="ì¸ì‚¬ë§ ì¶”ê°€..." style="flex:1;font-size:11px;" onkeydown="if(event.key==='Enter'){event.preventDefault();addGreeting('${pid}');}">
          <button class="btn btn-s btn-sm" onclick="addGreeting('${pid}')">ì¶”ê°€</button>
        </div>
      </div>
    </div>
  </div>
  <div>
    <div class="card" style="position:sticky;top:10px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;">
        <div class="ctitle" style="margin:0;" id="${p}mail_prevtitle">ğŸ“¨ ì»¨í… ë©”ì¼ (ë¯¸ë¦¬ë³´ê¸°)</div>
        <button class="btn btn-s btn-sm" onclick="genMail('${pid}')">â†º ë¯¸ë¦¬ë³´ê¸°</button>
      </div>
      <div class="notice n-i" id="${p}mail_notice">â€» ë‹‰ë„¤ì„ ë³€ìˆ˜ {ë‹‰ë„¤ì„}ì€ ë°œì†¡ ì‹œ ê° ë¸”ë¡œê±° ë‹‰ë„¤ì„ìœ¼ë¡œ ìë™ ì¹˜í™˜ë©ë‹ˆë‹¤.</div>
      <label class="lbl" style="margin-bottom:3px;">âœï¸ ë‚´ìš© ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥</label>
      <textarea class="mail-edit" id="${p}mailTA" rows="14"></textarea>
      <div style="margin-top:8px;display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
        <button class="btn btn-p" onclick="sendMailBulk('${pid}')">ğŸ“¤ ì¼ê´„ ë°œì†¡ (ë‹‰ë„¤ì„ ìë™ ì¹˜í™˜)</button>
        <button class="btn btn-s btn-sm" onclick="copyText(E('${p}mailTA').value).then(()=>toast('ë³µì‚¬ë¨','var(--a2)'))">ğŸ“‹ ë³µì‚¬</button>
        <span id="${p}mail_sendresult" style="font-size:11px;color:var(--a2);"></span>
      </div>
    </div>
  </div>
</div>`;}

function progHTML(pid){return`<div class="stitle">ì²´í—˜ë‹¨ ì§„í–‰ í˜„í™©</div><div class="ssub">ì—…ì²´ë³„ ë¸”ë¡œê±° í˜„í™©. ìƒíƒœ í´ë¦­ ì‹œ í•´ë‹¹ ìƒíƒœë§Œ í‘œì‹œ.</div><div class="fl" style="margin-bottom:10px;gap:6px;"><input id="${mk(pid,'prog_nick')}" placeholder="ğŸ” ë‹‰ë„¤ì„ ê²€ìƒ‰" style="width:140px;font-size:11px;" oninput="renderProgress('${pid}')"><label class="lbl" style="display:inline;">ì •ë ¬:</label><select id="${mk(pid,'prog_sort')}" onchange="renderProgress('${pid}')" style="width:auto;font-size:11px;"><option value="nick">ë‹‰ë„¤ì„</option><option value="idx">IDX</option><option value="rk">RK</option><option value="visitDate">ë°©ë¬¸ì¼</option></select><select id="${mk(pid,'prog_dir')}" onchange="renderProgress('${pid}')" style="width:auto;font-size:11px;"><option value="asc">ì˜¤ë¦„ì°¨ìˆœ</option><option value="desc">ë‚´ë¦¼ì°¨ìˆœ</option></select></div><div id="${mk(pid,'prog_container')}"></div>`;}

function excelHTML(pid){return`<div class="stitle">ì²´í—˜ë‹¨ ì§„í–‰ ì—‘ì…€íŒŒì¼</div><div class="ssub">ì—…ì²´Â·ì—°ë„Â·ì›”ì„ ì„ íƒí•˜ë©´ í•´ë‹¹ ê¸°ê°„ ë°©ë¬¸í•œ ë¸”ë¡œê±° ì •ë³´ë¥¼ ì—‘ì…€ë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤.</div>
<div class="card">
  <div class="ctitle">ë‚´ë³´ë‚´ê¸° ì„¤ì •</div>
  <div class="g3" style="margin-bottom:10px;">
    <div class="fg"><label class="lbl">ì—…ì²´ ì„ íƒ (ë³µìˆ˜)</label><div id="${mk(pid,'excel_bizlist')}" style="border:1px solid var(--bd);border-radius:7px;max-height:200px;overflow-y:auto;"></div></div>
    <div class="fg"><label class="lbl">ì—°ë„</label><select id="${mk(pid,'excel_year')}" style="margin-bottom:6px;" onchange="updateExcelPreview('${pid}')"></select>
      <label class="lbl">ì›” (ë³µìˆ˜)</label><div id="${mk(pid,'excel_monthlist')}" style="display:flex;flex-wrap:wrap;gap:4px;"></div>
    </div>
    <div class="fg"><label class="lbl">ë¯¸ë¦¬ë³´ê¸°</label><div id="${mk(pid,'excel_preview')}" style="font-size:11px;color:var(--m);padding:8px;background:var(--sf2);border-radius:7px;min-height:80px;">ì—…ì²´ì™€ ê¸°ê°„ì„ ì„ íƒí•˜ì„¸ìš”.</div></div>
  </div>
  <div style="display:flex;justify-content:flex-end;"><button class="btn btn-g" onclick="exportExcel('${pid}')">ğŸ“Š ì—‘ì…€ íŒŒì¼ ìƒì„±</button></div>
</div>`;}

function calHTML(pid){return`<div class="stitle">ì¼ì • ê´€ë¦¬</div><div class="ssub">ë¸”ë¡œê±° ë°©ë¬¸ ì¼ì • ë° ê¸°íƒ€ ì¼ì • ê´€ë¦¬.</div>
<div class="card">
  <div class="cal-nav"><button onclick="calNav('${pid}',-1)">â—€</button><div class="cal-title" id="${mk(pid,'cal_title')}"></div><button onclick="calNav('${pid}',1)">â–¶</button><button onclick="calNow('${pid}')" style="font-size:11px;">ì˜¤ëŠ˜</button></div>
  <div class="cal-grid" id="${mk(pid,'cal_daynames')}"></div>
  <div class="cal-grid" id="${mk(pid,'cal_grid')}" style="gap:3px;margin-top:3px;"></div>
</div>
<div class="qpanel" id="${mk(pid,'cal_evpanel')}" style="display:none;">
  <div class="qtitle" id="${mk(pid,'cal_evtitle')}">ì¼ì • ì¶”ê°€</div>
  <input type="hidden" id="${mk(pid,'cal_evid')}">
  <div class="g2" style="margin-bottom:7px;">
    <div class="fg"><label class="lbl">ë‚ ì§œ</label><input type="date" id="${mk(pid,'cal_evdate')}"></div>
    <div class="fg"><label class="lbl">ì œëª©</label><input id="${mk(pid,'cal_evtext')}" placeholder="ì¼ì • ë‚´ìš©"></div>
  </div>
  <div style="display:flex;justify-content:flex-end;gap:6px;">
    <button class="btn btn-s btn-sm" onclick="E('${mk(pid,'cal_evpanel')}').style.display='none'">ì·¨ì†Œ</button>
    <button class="btn btn-d btn-sm" id="${mk(pid,'cal_delbtn')}" onclick="delCalEvent('${pid}')" style="display:none;">ì‚­ì œ</button>
    <button class="btn btn-g btn-sm" onclick="saveCalEvent('${pid}')">ì €ì¥</button>
  </div>
</div>`;}

function bizmHTML(pid){const p=pid+'_';return`
<div class="stitle">ì—…ì²´ ê´€ë¦¬</div><div class="ssub">ì—…ì²´ ì •ë³´ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤.</div>
<div class="qpanel">
  <div class="qtitle" id="${p}bizm_ftitle">âš¡ ì—…ì²´ ì¶”ê°€</div>
  <div class="g2" style="margin-bottom:7px;">
    <div class="fg"><label class="lbl">ì—…ì²´ëª… *</label><input id="${p}b_name" placeholder="ì˜ˆ: â—‹â—‹ë ˆìŠ¤í† ë‘"></div>
    <div class="fg"><label class="lbl">ì§€ì—­</label><input id="${p}b_reg" placeholder="ì˜ˆ: ì„œìš¸ ê°•ë‚¨êµ¬"></div>
  </div>
  <div class="g2" style="margin-bottom:7px;">
    <div class="fg"><label class="lbl">ê³„ì•½ì¼</label><input type="date" id="${p}b_cs"></div>
    <div class="fg"><label class="lbl">ê³„ì•½ì¢…ë£Œì¼</label><input type="date" id="${p}b_ce"></div>
  </div>
  <div class="g2" style="margin-bottom:7px;">
    <div class="fg"><label class="lbl">ì—…ì²´ í”Œë ˆì´ìŠ¤ URL</label><input id="${p}b_url" placeholder="https://naver.me/..."></div>
    <div class="fg"><label class="lbl">êµ¬ê¸€í¼ ë§í¬</label><input id="${p}b_form" placeholder="https://forms.gle/..."></div>
  </div>
  <div class="fg" style="margin-bottom:7px;"><label class="lbl">ë°©ë¬¸ ê°€ëŠ¥ ì¼ì</label><input id="${p}b_visit" placeholder="í‰ì¼ 12ì‹œ~21ì‹œ"></div>
  <div class="g2" style="margin-bottom:7px;">
    <div class="fg"><label class="lbl">ê³µí†µì‚¬í•­ â‘¡</label><input id="${p}b_r2"></div>
    <div class="fg"><label class="lbl">ê³µí†µì‚¬í•­ â‘¢</label><input id="${p}b_r3"></div>
  </div>
  <div style="display:flex;justify-content:flex-end;gap:6px;">
    <input type="hidden" id="${p}b_editid">
    <button class="btn btn-s btn-sm" onclick="cancelBizEdit('${pid}')">ì´ˆê¸°í™”</button>
    <button class="btn btn-g" id="${p}b_savebtn" onclick="submitBiz('${pid}')">+ ì—…ì²´ ì¶”ê°€</button>
  </div>
</div>
<div class="card">
  <div class="abar">
    <div class="ctitle" style="margin:0;">ë“±ë¡ëœ ì—…ì²´ ëª©ë¡ <span id="${p}biz_count" class="mono"></span></div>
    <div class="fl"><span style="font-size:11px;color:var(--m);">ì •ë ¬:</span>
      <select id="${p}biz_sort" onchange="renderBizM('${pid}')" style="width:auto;font-size:11px;">
        <option value="status">ì§„í–‰/ì¢…ë£Œ</option><option value="contractDate">ê³„ì•½ì¼</option><option value="region">ì§€ì—­</option>
      </select>
    </div>
  </div>
  <div style="overflow-x:auto;"><table>
    <thead><tr><th>ìƒíƒœ</th><th>ì—…ì²´ëª… (ê²½ê³¼ì›”)</th><th>ì§€ì—­</th><th>ê³„ì•½ì¼</th><th>ì¢…ë£Œì¼</th><th>í”Œë ˆì´ìŠ¤</th><th>êµ¬ê¸€í¼</th><th>ë°©ë¬¸ê°€ëŠ¥</th><th>ê³µí†µâ‘¡</th><th>ê³µí†µâ‘¢</th><th>ìˆ˜ì •/ì‚­ì œ</th></tr></thead>
    <tbody id="${p}biz_tbody"></tbody>
  </table></div>
</div>`;}

function kwmHTML(pid){const p=pid+'_';return`
<div class="stitle">ì—…ì²´ë³„ í‚¤ì›Œë“œ ê´€ë¦¬</div>
<div class="g2">
  <div>
    <div class="card">
      <div class="fg" style="margin-bottom:8px;"><label class="lbl">ì—…ì²´ ì„ íƒ</label><select id="${p}bizsel" onchange="renderKeywords('${pid}')"><option value="">-- ì—…ì²´ ì„ íƒ --</option></select></div>
      <button class="btn btn-g" onclick="openKwAdd('${pid}')">+ í‚¤ì›Œë“œ ì¶”ê°€</button>
    </div>
    <div id="${p}kw_list"></div>
  </div>
  <div>
    <div class="qpanel" id="${p}kw_formpanel" style="display:none;">
      <div class="qtitle" id="${p}kw_formtitle">í‚¤ì›Œë“œ ì¶”ê°€</div>
      <input type="hidden" id="${p}kw_id">
      <div class="g2" style="margin-bottom:7px;">
        <div class="fg"><label class="lbl">í‚¤ì›Œë“œ *</label><input id="${p}kw_name" placeholder="í‚¤ì›Œë“œ"></div>
        <div class="fg"><label class="lbl">í‚¤ì›Œë“œ ì‚¬ì´ì¦ˆ</label><input id="${p}kw_size"></div>
      </div>
      <div class="fg" style="margin-bottom:7px;"><label class="lbl">ê²½ìŸê°•ë„</label><input id="${p}kw_comp"></div>
      <div class="fg" style="margin-bottom:7px;">
        <label class="lbl">ìŠ¤ë§ˆíŠ¸ë¸”ë¡ (LV/ìˆœìœ„, ë„ì–´ì“°ê¸° êµ¬ë¶„)</label>
        <input id="${p}kw_smart" placeholder="ì˜ˆ: 3/15 4/20 3/8" oninput="calcSmartPrev('${pid}')">
        <div id="${p}kw_smartprev" style="font-size:11px;color:var(--a2);margin-top:2px;"></div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:6px;">
        <button class="btn btn-s btn-sm" onclick="E('${p}kw_formpanel').style.display='none'">ì·¨ì†Œ</button>
        <button class="btn btn-g" onclick="saveKeyword('${pid}')">ì €ì¥</button>
      </div>
    </div>
  </div>
</div>`;}

function kwrecHTML(pid){const p=pid+'_';return`
<div class="stitle">ìƒìœ„ë…¸ì¶œ í‚¤ì›Œë“œ ì¶”ì²œ</div>
<div class="g3">
  <div><div class="card">
    <div class="fg" style="margin-bottom:7px;"><label class="lbl">ì—…ì²´ ì„ íƒ</label><select id="${p}bizsel" onchange="loadRecBiz('${pid}')"><option value="">-- ì—…ì²´ ì„ íƒ --</option></select></div>
    <div class="ctitle" style="margin-bottom:5px;">í‚¤ì›Œë“œ ì„ íƒ (ë³µìˆ˜, ì‚¬ì´ì¦ˆ ìˆœ)</div>
    <div id="${p}rec_kwlist" style="max-height:300px;overflow-y:auto;"></div>
  </div></div>
  <div><div class="card">
    <div class="ctitle" style="margin-bottom:5px;">ë¸”ë¡œê±° ì„ íƒ</div>
    <div id="${p}rec_blist" style="max-height:340px;overflow-y:auto;border:1px solid var(--bd);border-radius:7px;"></div>
  </div></div>
  <div>
    <div id="${p}rec_result" style="display:none;">
      <div class="card" id="${p}rec_binfo"><div class="ctitle">ë¸”ë¡œê±° ì •ë³´</div></div>
      <div class="card" id="${p}rec_kinfo"><div class="ctitle">ì„ íƒ í‚¤ì›Œë“œ ì •ë³´</div></div>
    </div>
    <div id="${p}rec_empty" class="card" style="text-align:center;color:var(--m);font-size:12px;padding:20px;">ë¸”ë¡œê±°ì™€ í‚¤ì›Œë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
  </div>
</div>`;}

function setHTML(pid){const p=pid+'_';return`
<div class="stitle">ì„¤ì •</div><div class="ssub">Firebase ì—°ê²° ë° ë„¤ì´ë²„ì›ìŠ¤ API ì„¤ì •.</div>
<div class="card"><div class="ctitle">Firebase ìƒíƒœ</div><div id="${p}fb_status" class="notice n-i" style="font-size:12px;">í™•ì¸ ì¤‘...</div></div>
<div class="card">
  <div class="ctitle">ë„¤ì´ë²„ì›ìŠ¤ ë©”ì¼ API</div>
  <div class="infobox">ë„¤ì´ë²„ì›ìŠ¤ OAuth 2.0 Access Tokenì„ ì…ë ¥í•˜ì„¸ìš”.</div>
  <div class="g2" style="margin-bottom:7px;">
    <div class="fg"><label class="lbl">Client ID</label><input id="${p}nw_cid" placeholder="Client ID"></div>
    <div class="fg"><label class="lbl">Client Secret</label><input id="${p}nw_cs" type="password"></div>
  </div>
  <div class="fg" style="margin-bottom:7px;"><label class="lbl">ë°œì‹ ì ê³„ì • (userId)</label><input id="${p}nw_uid" placeholder="user@company.com"></div>
  <div class="fg" style="margin-bottom:7px;"><label class="lbl">Access Token</label><input id="${p}nw_token" placeholder="Bearer Token"></div>
  <div class="fl"><button class="btn btn-s btn-sm" onclick="saveNWSettings('${pid}')">ì €ì¥</button><button class="btn btn-s btn-sm" onclick="testNWMail('${pid}')">í…ŒìŠ¤íŠ¸</button></div>
  <div id="${p}nw_status" style="font-size:11px;margin-top:6px;color:var(--m);"></div>
</div>
<div class="card">
  <div class="ctitle">ì¹´ì¹´ì˜¤í†¡ API</div>
  <div class="fg" style="margin-bottom:7px;"><label class="lbl">Kakao Access Token</label><input id="${p}kakao_token" placeholder="Kakao Access Token"></div>
  <button class="btn btn-s btn-sm" onclick="saveKakaoSettings('${pid}')">ì €ì¥</button>
</div>`;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAGE: ì‹ ê·œ ë¸”ë¡œê±°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const nbState={};
function getNBS(pid){if(!nbState[pid])nbState[pid]={sort:{k:'nick',d:'asc'},page:1,memos:[]};return nbState[pid];}

function initNB(pid){
  fillIdxSel(pid,'nb_idx','');
  renderNB(pid);
}

function sortNB(pid,k){
  const s=getNBS(pid);
  if(s.sort.k===k)s.sort.d=s.sort.d==='asc'?'desc':'asc';else{s.sort.k=k;s.sort.d='asc';}
  s.page=1;renderNB(pid);
}

function nbAddMemo(pid){
  const el=pE(pid,'nb_mnew')||E(mk(pid,'nb_mnew'));if(!el||!el.value.trim())return;
  getNBS(pid).memos.push({t:el.value.trim(),d:KRD()});
  el.value='';
  const ml=pE(pid,'nb_mlist')||E(mk(pid,'nb_mlist'));
  if(ml)ml.innerHTML=getNBS(pid).memos.map((m,i)=>`<div class="memo-item"><div><div class="memo-date">${x(m.d)}</div>${x(m.t)}</div><button style="background:none;border:none;color:var(--dn);cursor:pointer;" onclick="getNBS('${pid}').memos.splice(${i},1);nbAddMemo('${pid}')">Ã—</button></div>`).join('');
}

function nbCancel(pid){
  ['nb_nick','nb_email','nb_url','nb_rk','nb_kw','nb_kws','nb_mnew'].forEach(b=>{const el=pE(pid,b)||E(mk(pid,b));if(el)el.value='';});
  fillIdxSel(pid,'nb_idx','');
  const idel=pE(pid,'nb_id')||E(mk(pid,'nb_id'));if(idel)idel.value='';
  getNBS(pid).memos=[];
  const ml=pE(pid,'nb_mlist')||E(mk(pid,'nb_mlist'));if(ml)ml.innerHTML='';
  const ft=pE(pid,'nb_ftitle')||E(mk(pid,'nb_ftitle'));if(ft)ft.textContent='âš¡ ë¸”ë¡œê±° ì¶”ê°€';
  const sb=pE(pid,'nb_savebtn')||E(mk(pid,'nb_savebtn'));if(sb)sb.textContent='+ ì¶”ê°€';
}

async function nbSave(pid){
  const nick=pG(pid,'nb_nick')||(E(mk(pid,'nb_nick'))||{value:''}).value.trim();
  if(!nick){alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
  const existId=pG(pid,'nb_id')||(E(mk(pid,'nb_id'))||{value:''}).value;
  const isEdit=!!existId;
  if(!isEdit){const dup=EXISTB.find(b=>b.nick===nick);if(dup)toast(`âš ï¸ ê¸°ì¡´ ë¸”ë¡œê±°ì— "${nick}" ì´ë¯¸ ì¡´ì¬!`,'var(--a3)');}
  const gv=(b)=>pG(pid,b)||(E(mk(pid,b))||{value:''}).value.trim();
  const entry={nick,email:gv('nb_email'),url:gv('nb_url'),idx:gv('nb_idx'),rk:gv('nb_rk'),kw:gv('nb_kw'),kws:gv('nb_kws'),memos:[...getNBS(pid).memos],added:KRD(),rejected:false};
  const id=existId||uid();
  if(!db){
    const idx=NEWB.findIndex(b=>b.id===id);
    if(idx>=0)NEWB[idx]={id,...entry};else NEWB.push({id,...entry});
    localStorage.setItem('mm_newb_local',JSON.stringify(NEWB));
    renderNB(pid);nbCancel(pid);toast(`âœ“ "${nick}" ${isEdit?'ìˆ˜ì •':'ì¶”ê°€'}ë¨`,'var(--a2)');return;
  }
  try{await fsSet('newBloggers',id,entry);
    // ì—…ì²´ë³„ ë¸”ë¡œê±° ë™ê¸°í™” (ë‹‰ë„¤ì„/ì´ë©”ì¼/ë¸”ë¡œê·¸ ì—…ë°ì´íŠ¸)
    if(isEdit){
      const matching=BIZB.filter(b=>b.nick===entry.nick||(entry.email&&b.email===entry.email));
      await Promise.all(matching.map(b=>fsUpd('bizBloggers',b.id,{nick:entry.nick,email:entry.email,url:entry.url,idx:entry.idx})));
    }
    nbCancel(pid);toast(`âœ“ "${nick}" ${isEdit?'ìˆ˜ì •':'ì¶”ê°€'}ë¨`,'var(--a2)');}
  catch(e){toast('ì˜¤ë¥˜: '+e.message,'var(--dn)');}
}

function nbEdit(pid,id){
  const b=NEWB.find(b=>b.id===id);if(!b)return;
  const sv=(base,v)=>{const el=pE(pid,base)||E(mk(pid,base));if(el)el.value=ss(v);};
  sv('nb_id',b.id);sv('nb_nick',b.nick);sv('nb_email',b.email);sv('nb_url',b.url);sv('nb_rk',b.rk);sv('nb_kw',b.kw);sv('nb_kws',b.kws);
  fillIdxSel(pid,'nb_idx',b.idx||'');
  getNBS(pid).memos=[...(b.memos||[])];
  const ml=pE(pid,'nb_mlist')||E(mk(pid,'nb_mlist'));
  if(ml)ml.innerHTML=getNBS(pid).memos.map((m,i)=>`<div class="memo-item"><div><div class="memo-date">${x(m.d)}</div>${x(m.t)}</div></div>`).join('');
  const ft=pE(pid,'nb_ftitle')||E(mk(pid,'nb_ftitle'));if(ft)ft.textContent='âœï¸ ë¸”ë¡œê±° ìˆ˜ì •';
  const sb=pE(pid,'nb_savebtn')||E(mk(pid,'nb_savebtn'));if(sb)sb.textContent='ìˆ˜ì • ì €ì¥';
}

async function nbDel(id){
  const b=NEWB.find(b=>b.id===id);if(!b)return;
  if(!confirm(`"${b.nick}" ì‚­ì œ?`))return;
  if(!db){NEWB=NEWB.filter(b=>b.id!==id);localStorage.setItem('mm_newb_local',JSON.stringify(NEWB));panels.forEach(p=>{if(p.pageKey==='nb')renderNB(p.id);});toast('ì‚­ì œë¨','var(--m)');return;}
  await fsDel('newBloggers',id);toast('ì‚­ì œë¨','var(--m)');
}

function renderNB(pid){
  const s=getNBS(pid);
  const q=(pG(pid,'nb_srch')||(E(mk(pid,'nb_srch'))||{value:''}).value||'').toLowerCase();
  let list=NEWB.filter(b=>!q||[b.nick,b.email,b.kw,b.kws].join(' ').toLowerCase().includes(q));
  list.sort((a,b2)=>{
    if(!!a.rejected!==!!b2.rejected)return a.rejected?1:-1;
    let va,vb;
    if(s.sort.k==='idx'){va=idxRank(a.idx);vb=idxRank(b2.idx);}
    else if(s.sort.k==='rk'){va=parseFloat(a.rk)||0;vb=parseFloat(b2.rk)||0;}
    else{va=(a.nick||'').toLowerCase();vb=(b2.nick||'').toLowerCase();}
    const cmp=typeof va==='string'?va.localeCompare(vb,'ko'):va-vb;
    return cmp!==0?(s.sort.d==='asc'?cmp:-cmp):(a.nick||'').localeCompare(b2.nick||'','ko');
  });
  const cnt=pE(pid,'nb_count')||E(mk(pid,'nb_count'));if(cnt)cnt.textContent=NEWB.length+'ëª…'+(list.length<NEWB.length?` (ê²€ìƒ‰:${list.length}ëª…)`:'');
  const page=s.page;
  const pg=list.slice((page-1)*PER,page*PER);
  const tb=pE(pid,'nb_tbody')||E(mk(pid,'nb_tbody'));if(!tb)return;
  if(!pg.length){tb.innerHTML=`<tr><td colspan="9"><div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">ì‹ ê·œ ë¸”ë¡œê±°ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</div></div></td></tr>`;return;}
  tb.innerHTML=pg.map(b=>{
    const lm=(b.memos||[]).slice(-1)[0];
    return`<tr${b.rejected?' style="opacity:.5;"':''}>
      <td><strong>${x(b.nick)}</strong>${b.rejected?'<span class="xmark">âœ•</span>':''}</td>
      <td class="mono" style="font-size:10px;">${x(b.email)||'-'}</td>
      <td>${b.url?`<a href="${x(b.url)}" target="_blank" class="bl">ë§í¬â†—</a>`:'-'}</td>
      <td>${idxBadge(b.idx)}</td>
      <td style="font-size:11px;">${x(b.rk)||'-'}</td>
      <td style="font-size:11px;">${x(b.kw)||'-'}</td>
      <td style="font-size:11px;">${x(b.kws)||'-'}</td>
      <td style="font-size:11px;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${lm?x(lm.t):'-'}</td>
      <td><div class="fl" style="gap:3px;">
        <button class="btn btn-s btn-xs" onclick="nbEdit('${pid}','${b.id}')">ìˆ˜ì •</button>
        <button class="btn btn-d btn-xs" onclick="nbDel('${b.id}')">ì‚­ì œ</button>
      </div></td>
    </tr>`;
  }).join('');
  renderPager(mk(pid,'nb_pager'),page,list.length,`(p)=>{getNBS('${pid}').page=p;renderNB('${pid}');}`);
}

// â•â•â•â• ê¸°ì¡´ ë¸”ë¡œê±° â•â•â•â•
const ebState={};
function getEBS(pid){if(!ebState[pid])ebState[pid]={sort:{k:'nick',d:'asc'},page:1,memos:[]};return ebState[pid];}

function initEB(pid){fillIdxSel(pid,'eb_idx','');renderEB(pid);}

function sortEB(pid,k){
  const s=getEBS(pid);
  if(s.sort.k===k)s.sort.d=s.sort.d==='asc'?'desc':'asc';else{s.sort.k=k;s.sort.d='asc';}
  s.page=1;renderEB(pid);
}

function parseEBSearch(q){
  const must=[],not=[];
  q.split(/\s+/).forEach(t=>{if(t.startsWith('+')&&t.length>1)must.push(t.slice(1).toLowerCase());else if(t.startsWith('-')&&t.length>1)not.push(t.slice(1).toLowerCase());else if(t)must.push(t.toLowerCase());});
  return{must,not};
}
function ebMatch(b,{must,not}){
  const hay=[b.nick,b.name,b.email,b.url,b.phone,b.idx,b.rk,b.lv,b.rank,b.sc,(b.memos||[]).map(m=>m.t).join(' ')].join(' ').toLowerCase();
  for(const w of must)if(!hay.includes(w))return false;
  for(const w of not)if(hay.includes(w))return false;
  return true;
}

function renderEB(pid){
  const s=getEBS(pid);
  const q=(pG(pid,'eb_srch')||(E(mk(pid,'eb_srch'))||{value:''}).value||'').trim();
  const parsed=parseEBSearch(q);
  let list=EXISTB.filter(b=>ebMatch(b,parsed));
  list.sort((a,b2)=>{
    let va,vb;
    if(s.sort.k==='idx'){va=idxRank(a.idx);vb=idxRank(b2.idx);}
    else if(s.sort.k==='sc'){va=parseFloat(a.sc)||0;vb=parseFloat(b2.sc)||0;}
    else if(s.sort.k==='rk'){va=parseFloat(a.rk)||0;vb=parseFloat(b2.rk)||0;}
    else if(s.sort.k==='lv'){va=parseFloat(a.lv)||0;vb=parseFloat(b2.lv)||0;}
    else if(s.sort.k==='rank'){va=parseFloat(a.rank)||0;vb=parseFloat(b2.rank)||0;}
    else{va=(a.nick||'').toLowerCase();vb=(b2.nick||'').toLowerCase();}
    const cmp=typeof va==='string'?va.localeCompare(vb,'ko'):va-vb;
    return cmp!==0?(s.sort.d==='asc'?cmp:-cmp):(a.nick||'').localeCompare(b2.nick||'','ko');
  });
  const cnt=pE(pid,'eb_count')||E(mk(pid,'eb_count'));if(cnt)cnt.textContent=EXISTB.length+'ëª…'+(list.length<EXISTB.length?` (ê²€ìƒ‰:${list.length}ëª…)`:'');
  const page=s.page;
  const pg=list.slice((page-1)*PER,page*PER);
  const tb=pE(pid,'eb_tbody')||E(mk(pid,'eb_tbody'));if(!tb)return;
  const today=ISO();
  if(!pg.length){tb.innerHTML=`<tr><td colspan="9"><div class="empty"><div class="empty-icon">2ï¸âƒ£</div><div class="empty-text">ê¸°ì¡´ ë¸”ë¡œê±° ì—†ìŒ.</div></div></td></tr>`;return;}
  tb.innerHTML=pg.map(b=>{
    const expCls=b.expiryDate&&b.expiryDate<today?'color:var(--dn);':'';
    return`<tr class="clickrow" onclick="if(!event.target.closest('button'))openEBEdit('${pid}','${b.id}')">
      <td><strong>${x(b.nick)}</strong></td><td>${x(b.name)||'-'}</td>
      <td class="mono" style="font-size:10px;">${x(b.email)||'-'}</td>
      <td>${b.url?`<a href="${x(b.url)}" target="_blank" class="bl" onclick="event.stopPropagation()">ë§í¬â†—</a>`:'-'}</td>
      <td>${idxBadge(b.idx)}</td><td style="font-size:11px;">${x(b.rk)||'-'}</td>
      <td style="font-size:11px;">${x(b.lv)||'-'}</td><td style="font-size:11px;">${x(b.rank)||'-'}</td>
      <td style="font-size:11px;${expCls}">${x(b.sc)||'-'}</td>
    </tr>`;
  }).join('');
  renderPager(mk(pid,'eb_pager'),page,list.length,`(p)=>{getEBS('${pid}').page=p;renderEB('${pid}');}`);
}

function openEBEdit(pid,id){
  const b=EXISTB.find(b=>b.id===id);if(!b)return;
  const sv=(base,v)=>{const el=pE(pid,base)||E(mk(pid,base));if(el)el.value=ss(v);};
  sv('eb_id',b.id);sv('eb_nick',b.nick);sv('eb_name',b.name);sv('eb_email',b.email);sv('eb_url',b.url);sv('eb_phone',b.phone);sv('eb_rk',b.rk);sv('eb_lv',b.lv);sv('eb_rank',b.rank);sv('eb_sc',b.sc);sv('eb_acct',b.accountNum);sv('eb_ssn',b.ssn);sv('eb_excl',b.exclRegion);sv('eb_coldate',b.collectedDate);sv('eb_expdate',b.expiryDate);
  fillIdxSel(pid,'eb_idx',b.idx||'');
  getEBS(pid).memos=[...(b.memos||[])];
  const ml=pE(pid,'eb_mlist')||E(mk(pid,'eb_mlist'));
  if(ml)ml.innerHTML=getEBS(pid).memos.map((m,i)=>`<div class="memo-item"><div><div class="memo-date">${x(m.d)}</div>${x(m.t)}</div></div>`).join('');
  const hist=b.history||[];
  const histEl=pE(pid,'eb_history')||E(mk(pid,'eb_history'));
  if(histEl)histEl.innerHTML=hist.length===0?'ì—†ìŒ':`<table style="font-size:10px;width:100%;"><thead><tr><th>ì—…ì²´</th><th>ë°©ë¬¸ì¼</th><th>ê²€ìƒ‰ì–´</th><th>ì‚¬ì´ì¦ˆ</th><th>ì¡°ê±´</th><th>í¬ìŠ¤íŒ…</th></tr></thead><tbody>`+hist.map(h=>`<tr><td>${x(h.bizName)||'-'}</td><td>${x(h.visitDate)||'-'}</td><td>${x(h.kw)||'-'}</td><td>${x(h.kws)||'-'}</td><td>${x(h.cond)||'-'}</td><td>${h.postUrl?`<a href="${x(h.postUrl)}" target="_blank" class="bl">ë§í¬â†—</a>`:'-'}</td></tr>`).join('')+'</tbody></table>';
  const ep=pE(pid,'eb_editpanel')||E(mk(pid,'eb_editpanel'));if(ep){ep.style.display='block';ep.scrollIntoView({behavior:'smooth',block:'start'});}
}
function ebCloseEdit(pid){const ep=pE(pid,'eb_editpanel')||E(mk(pid,'eb_editpanel'));if(ep)ep.style.display='none';}
function ebAddMemo(pid){
  const el=pE(pid,'eb_mnew')||E(mk(pid,'eb_mnew'));if(!el||!el.value.trim())return;
  getEBS(pid).memos.push({t:el.value.trim(),d:KRD()});el.value='';
  const ml=pE(pid,'eb_mlist')||E(mk(pid,'eb_mlist'));
  if(ml)ml.innerHTML=getEBS(pid).memos.map(m=>`<div class="memo-item"><div><div class="memo-date">${x(m.d)}</div>${x(m.t)}</div></div>`).join('');
}
async function ebSave(pid){
  const id=(pE(pid,'eb_id')||E(mk(pid,'eb_id'))||{value:''}).value;if(!id)return;
  const oldB=EXISTB.find(b=>b.id===id)||{};
  const gv=(b)=>(pE(pid,b)||E(mk(pid,b))||{value:''}).value.trim();
  const updated={nick:gv('eb_nick'),name:gv('eb_name'),email:gv('eb_email'),url:gv('eb_url'),phone:gv('eb_phone'),idx:gv('eb_idx'),rk:gv('eb_rk'),lv:gv('eb_lv'),rank:gv('eb_rank'),sc:gv('eb_sc'),accountNum:gv('eb_acct'),ssn:gv('eb_ssn'),exclRegion:gv('eb_excl'),collectedDate:gv('eb_coldate'),expiryDate:gv('eb_expdate'),memos:[...getEBS(pid).memos],history:oldB.history||[],rkUpdateDate:ISO()};
  try{await fsSet('existingBloggers',id,updated);
    // ì—…ì²´ë³„ ë¸”ë¡œê±° ë™ê¸°í™” (ë‹‰ë„¤ì„/ì´ë©”ì¼/ë¸”ë¡œê·¸/IDX ì—…ë°ì´íŠ¸)
    const matching=BIZB.filter(b=>b.nick===oldB.nick||(oldB.email&&b.email===oldB.email));
    if(matching.length)await Promise.all(matching.map(b=>fsUpd('bizBloggers',b.id,{nick:updated.nick,email:updated.email,url:updated.url,idx:updated.idx})));
    ebCloseEdit(pid);toast('âœ“ ì €ì¥ë¨','var(--a2)');}
  catch(e){toast('ì˜¤ë¥˜: '+e.message,'var(--dn)');}
}
function expEB(){dcsv(['ë‹‰ë„¤ì„','ì´ë¦„','ì´ë©”ì¼','ë¸”ë¡œê·¸','IDX','RK','LV','ìˆœìœ„','SC','ê³„ì¢Œ','ì£¼ë¯¼ë²ˆí˜¸','ì œì™¸ì§€ì—­','ìˆ˜ì§‘ì¼','íŒŒê¸°ì¼'],EXISTB.map(b=>[b.nick,b.name,b.email,b.url,b.idx,b.rk,b.lv,b.rank,b.sc,b.accountNum,b.ssn,b.exclRegion,b.collectedDate,b.expiryDate]),'ê¸°ì¡´ë¸”ë¡œê±°.csv');}

// â•â•â•â• ì—…ì²´ë³„ ë¸”ë¡œê±° â•â•â•â•
const biz4State={};
function getBiz4S(pid){if(!biz4State[pid])biz4State[pid]={bizId:'',filter:'all',page:1,addOpen:false,gformOpen:false,q:''};return biz4State[pid];}

function initBiz4(pid){
  const sel=pE(pid,'bizsel')||E(mk(pid,'bizsel'));if(!sel)return;
  sel.innerHTML='<option value="">-- ì—…ì²´ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>'+BIZ.map(b=>`<option value="${b.id}">${x(b.name)}</option>`).join('');
  biz4FilterBar(pid);renderBiz4List(pid);
}

function biz4Change(pid){
  const s=getBiz4S(pid);
  s.bizId=(pE(pid,'bizsel')||E(mk(pid,'bizsel'))||{value:''}).value;
  s.filter='all';s.page=1;
  const biz=BIZ.find(b=>b.id===s.bizId);
  const t=pE(pid,'biz4_title')||E(mk(pid,'biz4_title'));if(t)t.textContent=biz?`${biz.name} ë¸”ë¡œê±° ëª©ë¡`:'ì—…ì²´ë¥¼ ì„ íƒí•˜ì„¸ìš”';
  biz4FilterBar(pid);renderBiz4List(pid);
  ['b4_infopanel','b4_rejpanel','b4_paypanel','b4_comppanel'].forEach(b=>{const el=pE(pid,b)||E(mk(pid,b));if(el)el.style.display='none';});
}

function biz4FilterBar(pid){
  const bar=pE(pid,'biz4_filterbar')||E(mk(pid,'biz4_filterbar'));if(!bar)return;
  const s=getBiz4S(pid);
  bar.innerHTML=[['all','ì „ì²´'],...STATUSES.map(st=>[st,st])].map(([k,l])=>`<button class="fbtn${s.filter===k?' on':''}" onclick="setBiz4F('${pid}','${k}',this)">${l}</button>`).join('');
}

function setBiz4F(pid,f,el){
  getBiz4S(pid).filter=f;getBiz4S(pid).page=1;
  document.querySelectorAll(`#${mk(pid,'biz4_filterbar')} .fbtn`).forEach(b=>b.classList.remove('on'));
  if(el)el.classList.add('on');renderBiz4List(pid);
}

function getBiz4List(pid){
  const s=getBiz4S(pid);if(!s.bizId)return[];
  let list=BIZB.filter(e=>e.bizId===s.bizId);
  if(s.filter!=='all')list=list.filter(e=>e.status===s.filter);
  return list.sort((a,b)=>{const so=STATUSES.indexOf(a.status)-STATUSES.indexOf(b.status);if(so!==0)return so;return(a.nick||'').localeCompare(b.nick||'','ko');});
}

function renderBiz4List(pid){
  const tb=pE(pid,'biz4_tbody')||E(mk(pid,'biz4_tbody'));if(!tb)return;
  const list=getBiz4List(pid),s=getBiz4S(pid);
  if(!list.length){tb.innerHTML=`<tr><td colspan="10"><div class="empty"><div class="empty-icon">4ï¸âƒ£</div><div class="empty-text">${s.bizId?'ë¸”ë¡œê±°ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.':'ì—…ì²´ë¥¼ ì„ íƒí•˜ì„¸ìš”.'}</div></div></td></tr>`;const pg=pE(pid,'biz4_pager')||E(mk(pid,'biz4_pager'));if(pg)pg.innerHTML='';return;}
  const today=ISO();
  const page=list.slice((s.page-1)*PER,s.page*PER);
  tb.innerHTML=page.map(e=>{
    const overdue=e.postDeadline&&e.postDeadline<today&&e.status!=='ì™„ë£Œ'&&e.status!=='ì¢…ë£Œ';
    return`<tr class="clickrow${overdue?' overdue':''}" onclick="if(!event.target.closest('select,button'))openB4Panel('${pid}','${e.id}')">
      <td><strong>${x(e.nick)}</strong>${e.rejected?'<span class="xmark">âœ•</span>':''}</td>
      <td>${x(e.name)||'-'}</td><td class="mono" style="font-size:10px;">${x(e.phone)||'-'}</td>
      <td>${idxBadge(e.idx)}</td><td style="font-size:11px;">${x(e.rk)||'-'}</td>
      <td>
        <select style="border-radius:5px;font-size:11px;padding:2px 5px;cursor:pointer;background:var(--sf2);border:1px solid var(--bd);color:var(--t);" onchange="onB4StatusChange('${pid}',this,'${e.id}')" onclick="event.stopPropagation()">
          ${STATUSES.map(st=>`<option value="${st}"${e.status===st?' selected':''}>${st}</option>`).join('')}
        </select>
      </td>
      <td style="font-size:11px;">${x(e.visitDate)||'-'} ${x(e.visitTime)||''}</td>
      <td style="font-size:11px;${overdue?'color:var(--dn);font-weight:600;':''}">${x(e.postDeadline)||'-'}</td>
      <td style="font-size:11px;">${e.postUrl?`<a href="${x(e.postUrl)}" target="_blank" class="bl" onclick="event.stopPropagation()">â†—</a>`:'-'}</td>
      <td onclick="event.stopPropagation()"><div class="fl" style="gap:3px;">
        ${e.status==='ì¢…ë£Œ'?`<button class="btn btn-o btn-xs" onclick="openB4Complete('${pid}','${e.id}')">ì´ë™</button>`:''}
        ${e.status==='ì™„ë£Œ'?`<button class="btn btn-p btn-xs" onclick="openB4PaymentPanel('${pid}','${e.id}')">ğŸ’³ ì…ê¸ˆì²˜</button>`:''}
        <button class="btn btn-d btn-xs" onclick="delBiz4Entry('${pid}','${e.id}')">ì‚­ì œ</button>
      </div></td>
    </tr>`;
  }).join('');
  renderPager(mk(pid,'biz4_pager'),s.page,list.length,`(p)=>{getBiz4S('${pid}').page=p;renderBiz4List('${pid}');}`);
}

async function onB4StatusChange(pid,sel,id){
  const newSt=sel.value;const entry=BIZB.find(e=>e.id===id);if(!entry)return;const oldSt=entry.status;if(newSt===oldSt)return;
  if(newSt==='ì¢…ë£Œ'&&(!entry.accountNum||!entry.ssn)){sel.value=oldSt;toast('âš ï¸ ì…ê¸ˆì²˜/ì‹ ë¶„ì¦ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.','var(--dn)');return;}
  if(newSt==='ì¼ì •í™•ì •'&&!entry.visitDate){sel.value=oldSt;toast('âš ï¸ ë°©ë¬¸ì¼ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.','var(--dn)');return;}
  await fsUpd('bizBloggers',id,{status:newSt});
  if(newSt==='ê±°ì ˆ')openB4RejectPanel(pid,id);
  else if(newSt==='ì¢…ë£Œ')openB4PaymentPanel(pid,id);
  toast(`"${entry.nick}" â†’ ${newSt}`,'var(--a2)');
}

function hideB4Panels(pid){['b4_infopanel','b4_rejpanel','b4_paypanel','b4_comppanel'].forEach(b=>{const el=pE(pid,b)||E(mk(pid,b));if(el)el.style.display='none';});}
function openB4Panel(pid,id){const e=BIZB.find(b=>b.id===id);if(!e)return;if(e.status==='ê±°ì ˆ')openB4RejectPanel(pid,id);else if(e.status==='ì¢…ë£Œ')openB4PaymentPanel(pid,id);else openB4InfoPanel(pid,id);}
function openB4InfoPanel(pid,id){
  const e=BIZB.find(b=>b.id===id);if(!e)return;
  const sv=(base,v)=>{const el=pE(pid,base)||E(mk(pid,base));if(el)el.value=ss(v);};
  sv('b4_eid',id);sv('b4_name',e.name);sv('b4_phone',e.phone);sv('b4_vdate',e.visitDate);sv('b4_vtime',e.visitTime);sv('b4_pdeadline',e.postDeadline);sv('b4_purl',e.postUrl);sv('b4_note',e.note);
  hideB4Panels(pid);const el=pE(pid,'b4_infopanel')||E(mk(pid,'b4_infopanel'));if(el){el.style.display='block';setTimeout(()=>el.scrollIntoView({behavior:'smooth',block:'nearest'}),50);}
}
async function saveB4Info(pid){
  const id=(pE(pid,'b4_eid')||E(mk(pid,'b4_eid'))||{value:''}).value;if(!id)return;
  const gv=(b)=>(pE(pid,b)||E(mk(pid,b))||{value:''}).value.trim();
  const data={name:gv('b4_name'),phone:gv('b4_phone'),visitDate:gv('b4_vdate'),visitTime:gv('b4_vtime'),postDeadline:gv('b4_pdeadline'),postUrl:gv('b4_purl'),note:gv('b4_note')};
  const e=BIZB.find(b=>b.id===id);
  if(data.visitDate&&e&&e.status==='ì¼ì •ì¡°ìœ¨')data.status='ì¼ì •í™•ì •';
  await fsUpd('bizBloggers',id,data);
  // ì‹ ê·œ ë¸”ë¡œê±°ì—ë„ ë™ê¸°í™”
  if(e){const nb=NEWB.find(b=>b.nick===e.nick||(e.email&&b.email===e.email));if(nb)await fsUpd('newBloggers',nb.id,{name:data.name,phone:data.phone});}
  const el=pE(pid,'b4_infopanel')||E(mk(pid,'b4_infopanel'));if(el)el.style.display='none';
  toast('âœ“ ì €ì¥ë¨','var(--a2)');
}
function openB4RejectPanel(pid,id){
  const e=BIZB.find(b=>b.id===id);if(!e)return;
  const sv=(base,v)=>{const el=pE(pid,base)||E(mk(pid,base));if(el)el.value=ss(v);};
  sv('b4_rejeid',id);sv('b4_rejreason',e.rejectReason||'');
  hideB4Panels(pid);const el=pE(pid,'b4_rejpanel')||E(mk(pid,'b4_rejpanel'));if(el){el.style.display='block';setTimeout(()=>el.scrollIntoView({behavior:'smooth',block:'nearest'}),50);}
}
async function saveB4Reject(pid){
  const id=(pE(pid,'b4_rejeid')||E(mk(pid,'b4_rejeid'))||{value:''}).value;
  const entry=BIZB.find(e=>e.id===id);if(!entry)return;
  const reason=(pE(pid,'b4_rejreason')||E(mk(pid,'b4_rejreason'))||{value:''}).value.trim();
  await fsUpd('bizBloggers',id,{status:'ê±°ì ˆ',rejectReason:reason,rejected:true});
  if(entry.newBId)await fsUpd('newBloggers',entry.newBId,{rejected:true});
  if(entry.existBId){const eb=EXISTB.find(b=>b.id===entry.existBId);if(eb){const memos=[...(eb.memos||[]),{t:`[ê±°ì ˆ] ${reason}`,d:KRD()}];await fsUpd('existingBloggers',entry.existBId,{memos});}}
  await fsDel('bizBloggers',id);
  const el=pE(pid,'b4_rejpanel')||E(mk(pid,'b4_rejpanel'));if(el)el.style.display='none';
  toast('ê±°ì ˆ ì²˜ë¦¬ë¨','var(--m)');
}
function openB4PaymentPanel(pid,id){
  const e=BIZB.find(b=>b.id===id);if(!e)return;
  const sv=(base,v)=>{const el=pE(pid,base)||E(mk(pid,base));if(el)el.value=ss(v);};
  sv('b4_payeid',id);sv('b4_payacct',e.accountNum);sv('b4_payssn',e.ssn);
  hideB4Panels(pid);const el=pE(pid,'b4_paypanel')||E(mk(pid,'b4_paypanel'));if(el){el.style.display='block';setTimeout(()=>el.scrollIntoView({behavior:'smooth',block:'nearest'}),50);}
}
async function saveB4Payment(pid){
  const id=(pE(pid,'b4_payeid')||E(mk(pid,'b4_payeid'))||{value:''}).value;
  const acct=(pE(pid,'b4_payacct')||E(mk(pid,'b4_payacct'))||{value:''}).value.trim();const ssn=(pE(pid,'b4_payssn')||E(mk(pid,'b4_payssn'))||{value:''}).value.trim();
  if(!acct||!ssn){toast('ê³„ì¢Œë²ˆí˜¸ì™€ ì£¼ë¯¼ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.','var(--dn)');return;}
  await fsUpd('bizBloggers',id,{accountNum:acct,ssn,status:'ì¢…ë£Œ'});
  const e=BIZB.find(b=>b.id===id);
  if(e&&e.existBId)await fsUpd('existingBloggers',e.existBId,{accountNum:acct,ssn});
  const el=pE(pid,'b4_paypanel')||E(mk(pid,'b4_paypanel'));if(el)el.style.display='none';
  openB4Complete(pid,id);toast('âœ“ ì…ê¸ˆ ì •ë³´ ì €ì¥ë¨','var(--a2)');
}
function openB4Complete(pid,id){
  const e=BIZB.find(b=>b.id===id);if(!e)return;
  const sv=(base,v)=>{const el=pE(pid,base)||E(mk(pid,base));if(el)el.value=ss(v);};
  sv('b4_compeid',id);sv('b4_compkw',e.kw);sv('b4_compkws',e.kws);sv('b4_compcond',e.conditions||'');sv('b4_compvisit',e.visitDate);sv('b4_compurl',e.postUrl);
  hideB4Panels(pid);const el=pE(pid,'b4_comppanel')||E(mk(pid,'b4_comppanel'));if(el){el.style.display='block';setTimeout(()=>el.scrollIntoView({behavior:'smooth',block:'nearest'}),50);}
}
async function doB4Complete(pid){
  const id=(pE(pid,'b4_compeid')||E(mk(pid,'b4_compeid'))||{value:''}).value;
  const e=BIZB.find(b=>b.id===id);if(!e)return;
  const biz=BIZ.find(b=>b.id===e.bizId);
  const gv=(b)=>(pE(pid,b)||E(mk(pid,b))||{value:''}).value.trim();
  const histEntry={bizId:e.bizId,bizName:biz?biz.name:'',visitDate:gv('b4_compvisit'),kw:gv('b4_compkw'),kws:gv('b4_compkws'),cond:gv('b4_compcond'),postUrl:gv('b4_compurl'),addedDate:ISO()};
  try{
    const existB=EXISTB.find(b=>b.id===e.existBId);
    if(existB){await fsUpd('existingBloggers',e.existBId,{history:[...(existB.history||[]),histEntry]});}
    else{await fsSet('existingBloggers',uid(),{nick:e.nick,name:e.name||'',email:e.email||'',url:e.url||'',phone:e.phone||'',idx:e.idx||'',rk:e.rk||'',lv:e.lv||'',rank:e.rank||'',sc:e.sc||'',accountNum:e.accountNum||'',ssn:e.ssn||'',memos:e.memos||[],history:[histEntry],collectedDate:ISO()});}
    await fsDel('bizBloggers',id);
    const el=pE(pid,'b4_comppanel')||E(mk(pid,'b4_comppanel'));if(el)el.style.display='none';
    toast(`âœ“ "${e.nick}" ì™„ë£Œ â†’ ê¸°ì¡´ ë¸”ë¡œê±° ì´ë™ë¨`,'var(--a2)');
  }catch(err){toast('ì˜¤ë¥˜: '+err.message,'var(--dn)');}
}
async function delBiz4Entry(pid,id){if(!confirm('ì‚­ì œ?'))return;await fsDel('bizBloggers',id);toast('ì‚­ì œë¨','var(--m)');}
function biz4ToggleAdd(pid){
  const s=getBiz4S(pid);if(!s.bizId){alert('ì—…ì²´ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');return;}
  s.addOpen=!s.addOpen;const el=pE(pid,'biz4_addpanel')||E(mk(pid,'biz4_addpanel'));if(el)el.style.display=s.addOpen?'block':'none';
  if(s.addOpen){s.q='';const si=pE(pid,'biz4_srch')||E(mk(pid,'biz4_srch'));if(si)si.value='';biz4RenderBR(pid);}
}
function biz4ToggleGForm(pid){
  const s=getBiz4S(pid);if(!s.bizId){alert('ì—…ì²´ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');return;}
  s.gformOpen=!s.gformOpen;const el=pE(pid,'biz4_gformpanel')||E(mk(pid,'biz4_gformpanel'));if(el)el.style.display=s.gformOpen?'block':'none';
}
function biz4SearchB(pid){getBiz4S(pid).q=(pE(pid,'biz4_srch')||E(mk(pid,'biz4_srch'))||{value:''}).value;biz4RenderBR(pid);}
function biz4RenderBR(pid){
  const s=getBiz4S(pid);const q=(s.q||'').toLowerCase();
  const all=[...NEWB.filter(b=>!b.rejected).map(b=>({...b,_src:'ì‹ ê·œ'})),...EXISTB.map(b=>({...b,_src:'ê¸°ì¡´'}))];
  const list=q?all.filter(b=>(b.nick||'').toLowerCase().includes(q)):all;
  list.sort((a,b)=>(a.nick||'').localeCompare(b.nick||'','ko'));
  const div=pE(pid,'biz4_results')||E(mk(pid,'biz4_results'));if(!div)return;
  if(!list.length){div.innerHTML='<div style="padding:10px;color:var(--m);font-size:11px;">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';return;}
  div.innerHTML=list.slice(0,30).map(b=>{
    const already=BIZB.find(e=>e.bizId===s.bizId&&e.nick===b.nick);
    return`<div class="sri"><div><strong>${x(b.nick)}</strong> <span style="color:var(--m);font-size:10px;">${b._src}</span><div style="font-size:10px;color:var(--m);">${idxBadge(b.idx)} RK:${b.rk||'-'} LV:${b.lv||'-'}</div></div>${already?'<span style="font-size:10px;color:var(--m);">ì¶”ê°€ë¨</span>':`<button class="btn btn-g btn-xs" onclick="biz4AddBlogger('${pid}','${b.id}','${b._src}')">ì¶”ê°€</button>`}</div>`;
  }).join('');
}
async function biz4AddBlogger(pid,bloggerId,src){
  const s=getBiz4S(pid);
  const b=src==='ì‹ ê·œ'?NEWB.find(b=>b.id===bloggerId):EXISTB.find(b=>b.id===bloggerId);if(!b)return;
  if(BIZB.find(e=>e.bizId===s.bizId&&e.nick===b.nick)){toast(`"${b.nick}"ì€ ì´ë¯¸ ì¶”ê°€ë¨`,'var(--a3)');return;}
  const entry={bizId:s.bizId,newBId:src==='ì‹ ê·œ'?bloggerId:'',existBId:src==='ê¸°ì¡´'?bloggerId:'',nick:b.nick,name:b.name||'',email:b.email||'',phone:b.phone||'',url:b.url||'',idx:b.idx||'',rk:b.rk||'',lv:b.lv||'',rank:b.rank||'',sc:b.sc||'',kw:b.kw||'',kws:b.kws||'',memos:[],status:'ì‹ ê·œ',addedDate:ISO()};
  await fsAdd('bizBloggers',entry);toast(`âœ“ "${b.nick}" ì¶”ê°€ë¨`,'var(--a2)');biz4RenderBR(pid);
}
function expBiz4(pid){const list=getBiz4List(pid);dcsv(['ë‹‰ë„¤ì„','ì´ë¦„','ì—°ë½ì²˜','ì´ë©”ì¼','IDX','RK','ìƒíƒœ','ë°©ë¬¸ì¼','í¬ìŠ¤íŒ…ê¸°í•œ','í¬ìŠ¤íŒ…URL','ë¹„ê³ '],list.map(e=>[e.nick,e.name,e.phone,e.email,e.idx,e.rk,e.status,e.visitDate,e.postDeadline,e.postUrl,e.note]),'ì—…ì²´ë³„ë¸”ë¡œê±°.csv');}
function gformCSVFile(pid){const f=pE(pid,'gform_file')||E(mk(pid,'gform_file'));if(!f||!f.files[0])return;const r=new FileReader();r.onload=e=>{let t=e.target.result;if(t.charCodeAt(0)===0xFEFF)t=t.slice(1);const ta=pE(pid,'gform_paste')||E(mk(pid,'gform_paste'));if(ta)ta.value=t;};r.readAsText(f.files[0],'UTF-8');}
async function importGFormCSV(pid){
  const s=getBiz4S(pid);
  const ta=pE(pid,'gform_paste')||E(mk(pid,'gform_paste'));const text=(ta&&ta.value||'').trim();
  if(!text){alert('CSV ë‚´ìš© ì…ë ¥ ë˜ëŠ” íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');return;}
  const lines=text.split(/\r?\n/).filter(l=>l.trim());if(lines.length<2){alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');return;}
  const rows=lines.slice(1).map(parseCSVLine);let matched=0;
  for(const row of rows){
    const csvNick=(row[2]||'').trim(),csvEmail=(row[4]||'').trim();
    let entry=null;
    if(csvNick)entry=BIZB.find(e=>e.bizId===s.bizId&&e.nick===csvNick);
    if(!entry&&csvEmail)entry=BIZB.find(e=>e.bizId===s.bizId&&e.email===csvEmail);
    if(entry){const updates={};if(row[1]&&row[1].trim())updates.name=row[1].trim();if(row[3]&&row[3].trim())updates.phone=row[3].trim();if(csvEmail)updates.email=csvEmail;if(row[0])updates.timestamp=row[0];if(row[5])updates.url=row[5].trim();updates.status='êµ¬ê¸€í¼ìš”ì²­';await fsUpd('bizBloggers',entry.id,updates);matched++;}
  }
  const res=pE(pid,'gform_result')||E(mk(pid,'gform_result'));if(res)res.textContent=`âœ“ ${matched}ëª… ë§¤ì¹­ ì™„ë£Œ (${rows.length}í–‰)`;
  toast(`âœ“ ${matched}ëª… ë§¤ì¹­ë¨`,'var(--a2)');
}

// â•â•â•â• ë©”ì¼ â•â•â•â•
const mailState={};
function getMailS(pid){if(!mailState[pid])mailState[pid]={sit:1};return mailState[pid];}

const MAIL_SIT={
  1:{label:'ì»¨í…',targetStatus:'ì‹ ê·œ',title:'ğŸ“¨ ì»¨í… ë©”ì¼'},
  2:{label:'êµ¬ê¸€í¼ ìš”ì²­',targetStatus:'ìˆ˜ë½',title:'âœ… êµ¬ê¸€í¼ ìš”ì²­ ë©”ì¼'},
  3:{label:'ì˜ˆì•½ ì•ˆë‚´',targetStatus:'êµ¬ê¸€í¼ìš”ì²­',title:'ğŸ“… ì˜ˆì•½ ì•ˆë‚´ ë©”ì¼'},
  4:{label:'í¬ìŠ¤íŒ… ì™„ë£Œ í™•ì¸',targetStatus:'ë°©ë¬¸',title:'ğŸ“ í¬ìŠ¤íŒ… ì™„ë£Œ í™•ì¸ ë©”ì¼'},
};

// FIX 2: ìƒí™©ë³„ ì¸ì‚¬ë§ ê¸°ë³¸ê°’
const GREETING_DEFAULT={
  1:'ë‹¨ë°œì ì¸ í˜‘ì—…ì„ ë„˜ì–´ ì¥ê¸°ì ì¸ í˜‘ì—… ê´€ê³„ë¥¼ ê¸°ëŒ€í•˜ë©°, ìì„¸í•œ ì²´í—˜ë‹¨ ë‚´ìš©ì€ ì•„ë˜ ë‚´ìš©ì„ í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤. ',
  2:'í•¨ê»˜í•´ì£¼ì…”ì„œ ì§„ì‹¬ìœ¼ë¡œ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤â˜º',
  3:'ì˜ˆì•½ ì•ˆë‚´ ë“œë¦½ë‹ˆë‹¤ :)',
  4:'ì‘ì„±í•´ì£¼ì‹  í¬ìŠ¤íŒ… í™•ì¸í–ˆìŠµë‹ˆë‹¤^^\nì •ì„±ìŠ¤ëŸ¬ìš´ ë¦¬ë·° ì§„ì‹¬ìœ¼ë¡œ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.',
};

function selMailSit(pid,n){
  getMailS(pid).sit=n;
  const panel=E('c_'+pid);if(!panel)return;
  panel.querySelectorAll('.tb').forEach((b,i)=>{b.className='tb'+(i===n-1?' on':' t'+(i+1));});
  const desc=pE(pid,'mail_sitdesc')||E(mk(pid,'mail_sitdesc'));if(desc)desc.textContent=`ëŒ€ìƒ: ìƒíƒœ "${MAIL_SIT[n].targetStatus}" ì¸ ë¸”ë¡œê±°`;
  const pt=pE(pid,'mail_prevtitle')||E(mk(pid,'mail_prevtitle'));if(pt)pt.textContent=MAIL_SIT[n].title+' (ë¯¸ë¦¬ë³´ê¸°)';
  [1,2,3,4].forEach(i=>{const v=pE(pid,'mail_vars'+i)||E(mk(pid,'mail_vars'+i));if(v)v.style.display=i===n?'block':'none';});
  renderMailBloggerList(pid);
  genMail(pid);
  fillGreetingList(pid);
}

function fillMailBizSel(pid){
  const sels=[pE(pid,'bizsel'),E(mk(pid,'bizsel'))];
  sels.filter(Boolean).forEach(sel=>{const cur=sel.value;sel.innerHTML='<option value="">-- ì—…ì²´ ì„ íƒ --</option>'+BIZ.map(b=>`<option value="${b.id}">${x(b.name)}</option>`).join('');if(cur)sel.value=cur;});
}

function mailBizChange(pid){
  const bizId=(pE(pid,'bizsel')||E(mk(pid,'bizsel'))||{value:''}).value;
  const biz=BIZ.find(b=>b.id===bizId);
  if(biz){
    const sv=(base,v)=>{const el=pE(pid,base)||E(mk(pid,base));if(el)el.value=ss(v);};
    sv('mv_reg',biz.reg);sv('mv_store',biz.name);sv('mv_addr',biz.url);sv('mv_visit',biz.visit);sv('mv_r2',biz.r2);sv('mv_r3',biz.r3);sv('mv_form',biz.form);
  }
  renderMailBloggerList(pid);genMail(pid);
}

function renderMailBloggerList(pid){
  const n=getMailS(pid).sit;const sit=MAIL_SIT[n];
  const bizId=(pE(pid,'bizsel')||E(mk(pid,'bizsel'))||{value:''}).value;
  const el=pE(pid,'mail_blist')||E(mk(pid,'mail_blist'));if(!el)return;
  const bloggers=BIZB.filter(e=>e.bizId===bizId&&e.status===sit.targetStatus).sort((a,b)=>(a.nick||'').localeCompare(b.nick||'','ko'));
  if(!bloggers.length){el.innerHTML=`<div style="padding:10px;font-size:11px;color:var(--m);">ìƒíƒœ "${sit.targetStatus}"ì¸ ë¸”ë¡œê±° ì—†ìŒ</div>`;const sc=pE(pid,'mail_selcnt')||E(mk(pid,'mail_selcnt'));if(sc)sc.textContent='';return;}
  el.innerHTML=bloggers.map(b=>`<label class="check-bl-item"><input type="checkbox" value="${b.id}" name="${mk(pid,'mail_b')}" onchange="updateMailCount('${pid}')"><span><strong>${x(b.nick)}</strong> <span style="font-size:10px;color:var(--m);">${x(b.email)||'ì´ë©”ì¼ì—†ìŒ'}</span></span></label>`).join('');
  updateMailCount(pid);
}

function toggleMailCheckAll(pid,checked){
  document.querySelectorAll(`input[name="${mk(pid,'mail_b')}"]`).forEach(i=>i.checked=checked);
  updateMailCount(pid);
}
function updateMailCount(pid){
  const cnt=document.querySelectorAll(`input[name="${mk(pid,'mail_b')}"]:checked`).length;
  const total=document.querySelectorAll(`input[name="${mk(pid,'mail_b')}"]`).length;
  const el=pE(pid,'mail_selcnt')||E(mk(pid,'mail_selcnt'));if(el)el.textContent=`${cnt}/${total}ëª… ì„ íƒ`;
  const ca=pE(pid,'mail_checkall')||E(mk(pid,'mail_checkall'));if(ca)ca.checked=cnt===total&&total>0;
}

function getGV(pid,base){return(pE(pid,base)||E(mk(pid,base))||{value:''}).value||'';}

// ë©”ì¼ ë³¸ë¬¸ ìƒì„± (ë‹‰ë„¤ì„ ìë¦¬ì— {ë‹‰ë„¤ì„} placeholder)
function tmplText(pid,nick){
  const n=getMailS(pid).sit;
  const NM=nick||'{ë‹‰ë„¤ì„}';
  const greeting=GREETING_DEFAULT[n];
  if(n===1){
    const reg=getGV(pid,'mv_reg')||'{ì§€ì—­}';const store=getGV(pid,'mv_store')||'{ìƒí˜¸ëª…}';
    const meal=getGV(pid,'mv_meal')?getGV(pid,'mv_meal')+'ë§Œì›':'Në§Œì›';const fee=getGV(pid,'mv_fee')?getGV(pid,'mv_fee')+'ë§Œì›':'Në§Œì›';
    const addr=getGV(pid,'mv_addr')||'{í”Œë ˆì´ìŠ¤URL}';const visit=getGV(pid,'mv_visit')||'(ë°©ë¬¸ê°€ëŠ¥ì¼ì)';
    const r2=getGV(pid,'mv_r2');const r3=getGV(pid,'mv_r3');
    const commonLines=['1ï¸âƒ£ 1,000ì ì´ìƒ/ ì‚¬ì§„ 15ì¥ ì´ìƒ/ í”Œë ˆì´ìŠ¤ ì§€ë„ ì‚½ì…/ ì¸ìš©êµ¬ í™œìš©'];
    if(r2)commonLines.push(`2ï¸âƒ£ ${r2}`);
    if(r3)commonLines.push(`3ï¸âƒ£ ${r3}`);
    return `ì•ˆë…•í•˜ì„¸ìš”, ${NM}ë‹˜!\në¸Œëœë“œì™€ ë¸”ë¡œê±°ì˜ í˜‘ì—…ì„ ë•ëŠ” ë§ˆì¸ì¦ˆë§ˆì¼€íŒ… ë‹´ë‹¹ìì…ë‹ˆë‹¤.\ní˜„ì¬ ${reg}ì— ìœ„ì¹˜í•œ <${store}> ì²´í—˜ë‹¨ì„ ëª¨ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤.\n\n${greeting}\n\n[<${store}> ì²´í—˜ë‹¨ ë‚´ìš©]\n\nâœ… ì œê³µ ë‚´ì—­\nììœ  ì‹ì‚¬ê¶Œ ${meal} + ì›ê³ ë£Œ ${fee}\n\nâœ… í‚¤ì›Œë“œ: ë³„ë„ ì•ˆë‚´\n\nâœ… ${store} í”Œë ˆì´ìŠ¤\n${addr}\n\nâœ… ë°©ë¬¸ ê°€ëŠ¥ ì¼ì\n${visit}\n\nâœ… ì‘ì„±ê¸°í•œ\në°©ë¬¸ í›„ 7ì¼ ì´ë‚´\n\nâœ… ì²´í—˜ë‹¨ ê³µí†µ ì‚¬í•­\n${commonLines.join('\n')}\n\nê´œì°®ìœ¼ì‹œë‹¤ë©´ ì§„í–‰ ì•ˆë‚´ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤!\nì¶”ê°€ ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“ ì§€ ì—°ë½ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.\n\nê°ì‚¬í•©ë‹ˆë‹¤.`;
  }
  if(n===2){
    const qna=getGV(pid,'mv_qna');const form=getGV(pid,'mv_form')||'{êµ¬ê¸€í¼ë§í¬}';
    return `ì•ˆë…•í•˜ì„¸ìš”, ${NM}ë‹˜.\n${greeting}\n${qna?'\n'+qna+'\n':''}\nì•„ë˜ êµ¬ê¸€í¼ì„ ì‘ì„±í•´ì£¼ì‹œë©´ í™•ì¸ í›„ ë°”ë¡œ ì˜ˆì•½ ì•ˆë‚´ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤ :)\n\n${form}\n\nê°ì‚¬í•©ë‹ˆë‹¤.`;
  }
  if(n===3){
    const bdate=getGV(pid,'mv_bookdate');const btime=getGV(pid,'mv_booktime');
    return `ì•ˆë…•í•˜ì„¸ìš”, ${NM}ë‹˜.\n${greeting}\n\në°©ë¬¸ ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nğŸ“… ì˜ˆì•½ ì¼ì‹œ: ${bdate||'(ë‚ ì§œ)'} ${btime||'(ì‹œê°„)'}\n\në°©ë¬¸ ì „ í™•ì¸ ë¶€íƒë“œë¦¬ë©°, ì¼ì • ë³€ê²½ì´ í•„ìš”í•˜ì‹œë©´ ë¯¸ë¦¬ ì—°ë½ ì£¼ì„¸ìš”.\n\nê°ì‚¬í•©ë‹ˆë‹¤.`;
  }
  return `ì•ˆë…•í•˜ì„¸ìš”, ${NM}ë‹˜.\n${greeting}\n\nì›ê³ ë£ŒëŠ” í¬ìŠ¤íŒ…ì´ ì—…ë¡œë“œëœ í•´ë‹¹ ì›”ì˜ ë§ì¼(ì£¼ë§ ë˜ëŠ” ê³µíœ´ì¼ì¼ ê²½ìš° ì „ë‚ )ì— ì¼ê´„ ì§€ê¸‰ë˜ë©°,\nì›ê³ ë£Œ ì…ê¸ˆ ë° ì›ì²œì§•ìˆ˜ë¥¼ ìœ„í•œ ì•„ë˜ ì„œë¥˜ ì „ë‹¬ì„ ë¶€íƒë“œë¦½ë‹ˆë‹¤.\n\n1. ì‹ ë¶„ì¦ ì‚¬ë³¸\n2. ì…ê¸ˆë°›ìœ¼ì‹¤ í†µì¥ ì‚¬ë³¸\n\nê°ì‚¬í•©ë‹ˆë‹¤.`;
}

function genMail(pid){
  const ta=pE(pid,'mailTA')||E(mk(pid,'mailTA'));if(!ta)return;
  ta.value=tmplText(pid,null);
}

// FIX 2: ì¸ì‚¬ë§ í´ë¦­ â†’ í˜„ì¬ ìƒí™©ì˜ ì¸ì‚¬ë§ ìœ„ì¹˜(greeting ìë¦¬)ë¥¼ êµì²´
function applyGreeting(pid,idx){
  const ta=pE(pid,'mailTA')||E(mk(pid,'mailTA'));if(!ta)return;
  const n=getMailS(pid).sit;
  const defaultGreeting=GREETING_DEFAULT[n];
  const customGreeting=mailGreetings[idx];
  if(customGreeting===undefined)return;
  let body=ta.value;
  if(body.includes(defaultGreeting)){
    ta.value=body.replace(defaultGreeting,customGreeting);
    toast('âœ“ ì¸ì‚¬ë§ ì ìš©ë¨','var(--a2)');
  } else {
    toast('ì¸ì‚¬ë§ ìœ„ì¹˜ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë¯¸ë¦¬ë³´ê¸° ìƒˆë¡œê³ ì¹¨ í›„ ì‹œë„í•˜ì„¸ìš”.','var(--a3)');
  }
}

// FIX 3: ì¼ê´„ë°œì†¡ - ë‹‰ë„¤ì„ ê°œì¸í™”
async function sendMailBulk(pid){
  const selected=[...document.querySelectorAll(`input[name="${mk(pid,'mail_b')}"]:checked`)].map(i=>i.value);
  if(!selected.length){alert('ë°›ëŠ” ì‚¬ëŒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');return;}
  const settings=JSON.parse(localStorage.getItem('mm_nw')||'{}');
  if(!settings.accessToken||!settings.userId){alert('ì„¤ì • íƒ­ì—ì„œ ë„¤ì´ë²„ì›ìŠ¤ API ì •ë³´ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
  const subject=getGV(pid,'mail_subject')||MAIL_SIT[getMailS(pid).sit].title;
  const baseBody=(pE(pid,'mailTA')||E(mk(pid,'mailTA'))||{value:''}).value;
  let sent=0,failed=0;
  const res=pE(pid,'mail_sendresult')||E(mk(pid,'mail_sendresult'));if(res)res.textContent='ë°œì†¡ ì¤‘...';
  for(const id of selected){
    const entry=BIZB.find(e=>e.id===id);if(!entry)continue;
    if(!entry.email){failed++;continue;}
    // FIX: {ë‹‰ë„¤ì„} â†’ ì‹¤ì œ ë‹‰ë„¤ì„ ì¹˜í™˜
    const personalBody=baseBody.replace(/\{ë‹‰ë„¤ì„\}/g,entry.nick||'');
    try{await sendNWMail(settings,entry.email,subject,personalBody);sent++;
      // ë©”ì¼ ë°œì†¡ í›„ ìƒíƒœ ìë™ ë³€ê²½
      const sit=getMailS(pid).sit;
      if(sit===2)await fsUpd('bizBloggers',entry.id,{status:'êµ¬ê¸€í¼ìš”ì²­'});
      else if(sit===3)await fsUpd('bizBloggers',entry.id,{status:'ì˜ˆì•½ì•ˆë‚´'});
    }
    catch(e){failed++;console.error(e);}
  }
  if(res)res.textContent=`âœ“ ${sent}ëª… ë°œì†¡${failed?`, ${failed}ëª… ì‹¤íŒ¨`:''}`;
  toast(`${sent}ëª… ë°œì†¡ ì™„ë£Œ`,'var(--a2)');
}

async function sendNWMail(settings,to,subject,body){
  const proxyUrl=`https://mindz-mail-proxy.tmdgks4940.workers.dev/?target=mail&userId=${encodeURIComponent(settings.userId)}`;
  const res=await fetch(proxyUrl,{
    method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${settings.accessToken}`},
    body:JSON.stringify({to,subject,body,contentType:"text",isSaveSentMail:true,isSendSeparately:false})
  });
  if(!res.ok)throw new Error(await res.text());
}

function fillGreetingList(pid){
  const el=pE(pid,'greeting_list')||E(mk(pid,'greeting_list'));if(!el)return;
  el.innerHTML=mailGreetings.map((g,i)=>`<div class="greeting-chip" onclick="applyGreeting('${pid}',${i})" title="í´ë¦­: ì¸ì‚¬ë§ ìœ„ì¹˜ì— ì‚½ì…">
    <span>${x(g)}</span>
    <button onclick="event.stopPropagation();delGreeting(${i})" style="background:none;border:none;color:var(--dn);cursor:pointer;font-size:12px;line-height:1;">Ã—</button>
  </div>`).join('');
}
function addGreeting(pid){
  const input=pE(pid,'greeting_new')||E(mk(pid,'greeting_new'));if(!input||!input.value.trim())return;
  mailGreetings.push(input.value.trim());input.value='';
  localStorage.setItem('mm_greet',JSON.stringify(mailGreetings));
  panels.forEach(p=>{if(p.pageKey==='mail')fillGreetingList(p.id);});
}
function delGreeting(i){mailGreetings.splice(i,1);localStorage.setItem('mm_greet',JSON.stringify(mailGreetings));panels.forEach(p=>{if(p.pageKey==='mail')fillGreetingList(p.id);});}

// â•â•â•â• ì§„í–‰ í˜„í™© â•â•â•â•
function renderProgress(pid){
  const container=pE(pid,'prog_container')||E(mk(pid,'prog_container'));if(!container)return;
  const sortKey=(pE(pid,'prog_sort')||E(mk(pid,'prog_sort'))||{value:'nick'}).value;
  const sortDir=(pE(pid,'prog_dir')||E(mk(pid,'prog_dir'))||{value:'asc'}).value;
  if(!BIZ.length){container.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“Š</div><div class="empty-text">ì—…ì²´ë¥¼ ë“±ë¡í•˜ì„¸ìš”.</div></div>';return;}
  const today=ISO();
  container.innerHTML=BIZ.map(biz=>{
    const bizBloggers=BIZB.filter(e=>e.bizId===biz.id);
    const bizFilter=(progressFilters[pid+biz.id])||'all';
    let display=bizFilter==='all'?bizBloggers:bizBloggers.filter(e=>e.status===bizFilter);
    if(nickQ)display=display.filter(e=>(e.nick||'').toLowerCase().includes(nickQ)||(e.name||'').toLowerCase().includes(nickQ));
    display.sort((a,b)=>{
      let va,vb;
      if(sortKey==='idx'){va=idxRank(a.idx);vb=idxRank(b.idx);}
      else if(sortKey==='rk'){va=parseFloat(a.rk)||0;vb=parseFloat(b.rk)||0;}
      else if(sortKey==='visitDate'){va=a.visitDate||'';vb=b.visitDate||'';}
      else{va=a.nick||'';vb=b.nick||'';}
      const cmp=typeof va==='string'?va.localeCompare(vb,'ko'):va-vb;
      return sortDir==='asc'?cmp:-cmp;
    });
    const stCounts={};STATUSES.forEach(s=>stCounts[s]=bizBloggers.filter(e=>e.status===s).length);
    return`<div style="margin-bottom:12px;">
      <div class="prog-biz-hdr" onclick="toggleProgBiz(this)">
        <div style="display:flex;align-items:center;gap:8px;"><strong>${x(biz.name)}</strong><span class="mono" style="font-size:10px;">${bizBloggers.length}ëª…</span></div>
        <span style="font-size:12px;color:var(--m);">â–¼</span>
      </div>
      <div class="prog-biz-body">
        <div class="prog-st-bar">
          <button class="fbtn${bizFilter==='all'?' on':''}" onclick="setProgFilter('${pid}','${biz.id}','all')">ì „ì²´(${bizBloggers.length})</button>
          ${STATUSES.filter(s=>stCounts[s]>0).map(s=>`<button class="fbtn${bizFilter===s?' on':''}" onclick="setProgFilter('${pid}','${biz.id}','${s}')">${s}(${stCounts[s]})</button>`).join('')}
        </div>
        ${display.length?`<div style="overflow-x:auto;"><table style="font-size:11px;"><thead><tr><th>ë‹‰ë„¤ì„</th><th>IDX</th><th>RK</th><th>ìƒíƒœ</th><th>ë°©ë¬¸ì¼</th><th>í¬ìŠ¤íŒ…ê¸°í•œ</th></tr></thead><tbody>
          ${display.map(e=>{const ov=e.postDeadline&&e.postDeadline<today&&e.status!=='ì™„ë£Œ'&&e.status!=='ì¢…ë£Œ';return`<tr${ov?' style="color:var(--dn);"':''}}><td><strong>${x(e.nick)}</strong></td><td>${idxBadge(e.idx)}</td><td>${x(e.rk)||'-'}</td><td>${stBadge(e.status)}</td><td>${x(e.visitDate)||'-'}</td><td${ov?' style="font-weight:600;"':''}>${x(e.postDeadline)||'-'}</td></tr>`;}).join('')}
        </tbody></table></div>`:'<div style="padding:10px;font-size:11px;color:var(--m);">í•´ë‹¹ ìƒíƒœ ì—†ìŒ</div>'}
      </div>
    </div>`;
  }).join('');
}
function toggleProgBiz(header){const body=header.nextElementSibling;if(body)body.style.display=body.style.display==='none'?'':'none';}
function setProgFilter(pid,bizId,status){progressFilters[pid+bizId]=status;renderProgress(pid);}

// â•â•â•â• ì—‘ì…€ â•â•â•â•
function initExcel(pid){
  const sel=pE(pid,'excel_year')||E(mk(pid,'excel_year'));if(!sel)return;
  const cur=new Date().getFullYear();
  sel.innerHTML=[cur-1,cur,cur+1].map(y=>`<option value="${y}"${y===cur?' selected':''}>${y}ë…„</option>`).join('');
  const ml=pE(pid,'excel_monthlist')||E(mk(pid,'excel_monthlist'));
  if(ml)ml.innerHTML=Array.from({length:12},(_,i)=>i+1).map(m=>`<label style="display:flex;align-items:center;gap:3px;font-size:11px;cursor:pointer;"><input type="checkbox" value="${m}" onchange="updateExcelPreview('${pid}')"> ${m}ì›”</label>`).join('');
  const bl=pE(pid,'excel_bizlist')||E(mk(pid,'excel_bizlist'));
  if(bl)bl.innerHTML=BIZ.map(b=>`<label class="check-bl-item"><input type="checkbox" value="${b.id}" onchange="updateExcelPreview('${pid}')"><span>${x(b.name)}</span></label>`).join('');
  updateExcelPreview(pid);
}
function updateExcelPreview(pid){
  const year=(pE(pid,'excel_year')||E(mk(pid,'excel_year'))||{value:''}).value;
  const months=[...document.querySelectorAll(`#${mk(pid,'excel_monthlist')} input:checked`)].map(i=>parseInt(i.value));
  const bizIds=[...document.querySelectorAll(`#${mk(pid,'excel_bizlist')} input:checked`)].map(i=>i.value);
  const prev=pE(pid,'excel_preview')||E(mk(pid,'excel_preview'));if(!prev)return;
  if(!bizIds.length||!months.length){prev.textContent='ì—…ì²´ì™€ ì›”ì„ ì„ íƒí•˜ì„¸ìš”.';return;}
  let cnt=0;bizIds.forEach(bizId=>{EXISTB.forEach(b=>{(b.history||[]).forEach(h=>{if(h.bizId!==bizId||!h.visitDate)return;const[y,m]=h.visitDate.split('-').map(Number);if(String(y)===year&&months.includes(m))cnt++;});});});
  prev.textContent=`ì˜ˆìƒ ${cnt}ê±´ì˜ ë°ì´í„°`;
}
function exportExcel(pid){
  const year=(pE(pid,'excel_year')||E(mk(pid,'excel_year'))||{value:''}).value;
  const months=[...document.querySelectorAll(`#${mk(pid,'excel_monthlist')} input:checked`)].map(i=>parseInt(i.value));
  const bizIds=[...document.querySelectorAll(`#${mk(pid,'excel_bizlist')} input:checked`)].map(i=>i.value);
  if(!bizIds.length){alert('ì—…ì²´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');return;}if(!months.length){alert('ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');return;}
  bizIds.forEach(bizId=>{
    const biz=BIZ.find(b=>b.id===bizId);const rows=[];
    EXISTB.forEach(b=>{(b.history||[]).forEach(h=>{if(h.bizId!==bizId||!h.visitDate)return;const[y,m]=h.visitDate.split('-').map(Number);if(String(y)!==year||!months.includes(m))return;rows.push([b.nick,b.name,b.email,b.url,b.phone,b.idx,b.rk,b.lv,b.rank,b.sc,b.accountNum,b.ssn,b.exclRegion,b.collectedDate,b.expiryDate,h.visitDate,h.kw,h.kws,h.cond,h.postUrl]);});});
    if(!rows.length)return;
    const ws=XLSX.utils.aoa_to_sheet([['ë‹‰ë„¤ì„','ì´ë¦„','ì´ë©”ì¼','ë¸”ë¡œê·¸','ì—°ë½ì²˜','IDX','RK','LV','ìˆœìœ„','SC','ê³„ì¢Œë²ˆí˜¸','ì£¼ë¯¼ë²ˆí˜¸','ì œì™¸ì§€ì—­','ì •ë³´ìˆ˜ì§‘ì¼','ì •ë³´íŒŒê¸°ì¼','ë°©ë¬¸ì¼','ê²€ìƒ‰ì–´','ê²€ìƒ‰ì–´ì‚¬ì´ì¦ˆ','ì¡°ê±´','í¬ìŠ¤íŒ…URL'],...rows]);
    const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'ì²´í—˜ë‹¨ë‚´ì—­');
    XLSX.writeFile(wb,`ì²´í—˜ë‹¨_${biz?biz.name:'ì—…ì²´'}_${year}_${months.join(',')}.xlsx`);
  });
  toast('âœ“ ì—‘ì…€ íŒŒì¼ ìƒì„±ë¨','var(--a2)');
}

// â•â•â•â• ìº˜ë¦°ë” â•â•â•â•
const calState={};
function initCalS(pid){if(!calState[pid]){const n=new Date();calState[pid]={year:n.getFullYear(),month:n.getMonth()};}}
function calNav(pid,dir){initCalS(pid);const s=calState[pid];s.month+=dir;if(s.month<0){s.month=11;s.year--;}if(s.month>11){s.month=0;s.year++;}renderCal(pid);}
function calNow(pid){const n=new Date();calState[pid]={year:n.getFullYear(),month:n.getMonth()};renderCal(pid);}
const DN=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
function renderCal(pid){
  initCalS(pid);const s=calState[pid];
  const tEl=pE(pid,'cal_title')||E(mk(pid,'cal_title'));if(!tEl)return;
  tEl.textContent=`${s.year}ë…„ ${s.month+1}ì›”`;
  const dn=pE(pid,'cal_daynames')||E(mk(pid,'cal_daynames'));
  if(dn)dn.innerHTML=DN.map((d,i)=>`<div class="cal-day-name" style="color:${i===0?'#e53935':i===6?'#1565c0':'var(--m)'}">${d}</div>`).join('');
  const first=new Date(s.year,s.month,1).getDay();const daysInM=new Date(s.year,s.month+1,0).getDate();const prevD=new Date(s.year,s.month,0).getDate();
  const today=ISO();const cells=[];
  for(let i=first-1;i>=0;i--)cells.push({date:null,day:prevD-i,other:true});
  for(let d=1;d<=daysInM;d++){const ds=`${s.year}-${String(s.month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;const dow=new Date(s.year,s.month,d).getDay();cells.push({date:ds,day:d,other:false,dow});}
  while(cells.length%7!==0)cells.push({date:null,day:0,other:true});
  const visitMap={};BIZB.forEach(e=>{if(e.visitDate){if(!visitMap[e.visitDate])visitMap[e.visitDate]=[];visitMap[e.visitDate].push(e.nick);}});
  const grid=pE(pid,'cal_grid')||E(mk(pid,'cal_grid'));if(!grid)return;
  grid.innerHTML=cells.map(c=>{
    if(!c.date)return`<div class="cal-day other-month"><div class="cal-day-num" style="color:var(--m);">${c.day||''}</div></div>`;
    const isT=c.date===today;const visits=visitMap[c.date]||[];const customs=CALEVENTS.filter(e=>e.date===c.date);
    const contracts=c.day===1?BIZ.filter(b=>b.contractStart).map(b=>{const mo=monthsDiff(b.contractStart);return`ğŸ“‹${b.name}(${mo}m)`;}):[]; 
    const numColor=c.dow===0?'#e53935':c.dow===6?'#1565c0':isT?'var(--a)':'var(--t)';
    const numStyle=isT?`display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;background:var(--a);color:#fff;border-radius:50%;font-size:11px;`:`color:${numColor};`;
    return`<div class="cal-day${isT?' today':''}" onclick="calOpenEvent('${pid}','${c.date}')">
      <div class="cal-day-num"><span style="${numStyle}">${c.day}</span></div>
      ${contracts.map(t=>`<div class="cal-event contract" title="${t}">${t}</div>`).join('')}
      ${visits.map(n=>`<div class="cal-event visit">ğŸ‘¤${n}</div>`).join('')}
      ${customs.map(e=>`<div class="cal-event custom">âœ¦ ${e.text}</div>`).join('')}
    </div>`;
  }).join('');
}
function calOpenEvent(pid,dateStr){
  const ep=pE(pid,'cal_evpanel')||E(mk(pid,'cal_evpanel'));if(!ep)return;
  const evdate=pE(pid,'cal_evdate')||E(mk(pid,'cal_evdate'));if(evdate)evdate.value=dateStr;
  const evtext=pE(pid,'cal_evtext')||E(mk(pid,'cal_evtext'));if(evtext)evtext.value='';
  const evid=pE(pid,'cal_evid')||E(mk(pid,'cal_evid'));if(evid)evid.value='';
  const db2=pE(pid,'cal_delbtn')||E(mk(pid,'cal_delbtn'));if(db2)db2.style.display='none';
  const t=pE(pid,'cal_evtitle')||E(mk(pid,'cal_evtitle'));if(t)t.textContent=`ì¼ì • ì¶”ê°€ - ${dateStr}`;
  ep.style.display='block';
}
async function saveCalEvent(pid){
  const date=(pE(pid,'cal_evdate')||E(mk(pid,'cal_evdate'))||{value:''}).value;const text=(pE(pid,'cal_evtext')||E(mk(pid,'cal_evtext'))||{value:''}).value;
  if(!date||!text){alert('ë‚ ì§œì™€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
  const id=(pE(pid,'cal_evid')||E(mk(pid,'cal_evid'))||{value:''}).value||uid();
  await fsSet('calEvents',id,{date,text});
  const ep=pE(pid,'cal_evpanel')||E(mk(pid,'cal_evpanel'));if(ep)ep.style.display='none';
  toast('âœ“ ì¼ì • ì €ì¥ë¨','var(--a2)');
}
async function delCalEvent(pid){
  const id=(pE(pid,'cal_evid')||E(mk(pid,'cal_evid'))||{value:''}).value;if(!id)return;
  await fsDel('calEvents',id);const ep=pE(pid,'cal_evpanel')||E(mk(pid,'cal_evpanel'));if(ep)ep.style.display='none';toast('ì‚­ì œë¨','var(--m)');
}

// â•â•â•â• ì—…ì²´ ê´€ë¦¬ (FIX 4: ì¦‰ì‹œ ë¡œì»¬ ì—…ë°ì´íŠ¸) â•â•â•â•
function getBizStatus(b){if(!b.contractEnd)return'ì§„í–‰';return b.contractEnd>=ISO()?'ì§„í–‰':'ì¢…ë£Œ';}
function renderBizM(pid){
  const tb=pE(pid,'biz_tbody')||E(mk(pid,'biz_tbody'));if(!tb)return;
  const cnt=pE(pid,'biz_count')||E(mk(pid,'biz_count'));if(cnt)cnt.textContent=BIZ.length+'ê°œ';
  const sortBy=(pE(pid,'biz_sort')||E(mk(pid,'biz_sort'))||{value:'status'}).value;
  const list=[...BIZ].sort((a,b)=>{
    const sa=getBizStatus(a),sb=getBizStatus(b);
    if(sortBy==='status'){if(sa!==sb)return sa==='ì§„í–‰'?-1:1;return(b.contractStart||'').localeCompare(a.contractStart||'');}
    if(sortBy==='contractDate')return(b.contractStart||'').localeCompare(a.contractStart||'');
    if(sortBy==='region')return(a.reg||'').localeCompare(b.reg||'','ko');
    return 0;
  });
  if(!list.length){tb.innerHTML=`<tr><td colspan="11"><div class="empty"><div class="empty-icon">ğŸ¢</div><div class="empty-text">ì—…ì²´ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</div></div></td></tr>`;return;}
  const today=ISO();
  tb.innerHTML=list.map(b=>{
    const status=getBizStatus(b);const months=b.contractStart?monthsDiff(b.contractStart):'-';
    return`<tr class="clickrow" onclick="if(!event.target.closest('button,a'))editBiz('${pid}','${b.id}')">
      <td><span style="font-size:10px;font-weight:700;color:${status==='ì§„í–‰'?'var(--a2)':'var(--dn)'};">${status}</span></td>
      <td><strong>${x(b.name)}</strong>${b.contractStart?`<span style="font-size:10px;color:var(--m);margin-left:4px;">(${months}ê°œì›”)</span>`:''}</td>
      <td style="font-size:11px;color:var(--m);">${x(b.reg)||'-'}</td>
      <td style="font-size:11px;font-family:'DM Mono',monospace;">${x(b.contractStart)||'-'}</td>
      <td style="font-size:11px;font-family:'DM Mono',monospace;${b.contractEnd&&b.contractEnd<today?'color:var(--dn);':''}">${x(b.contractEnd)||'-'}</td>
      <td>${b.url?`<a href="${x(b.url)}" target="_blank" class="bl">ë§í¬â†—</a>`:'-'}</td>
      <td>${b.form?`<a href="${x(b.form)}" target="_blank" class="bl">í¼â†—</a>`:'-'}</td>
      <td style="font-size:11px;color:var(--m);">${x(b.visit)||'-'}</td>
      <td style="font-size:11px;color:var(--m);max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${x(b.r2)||'-'}</td>
      <td style="font-size:11px;color:var(--m);max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${x(b.r3)||'-'}</td>
      <td><div class="fl" style="gap:3px;">
        <button class="btn btn-s btn-xs" onclick="editBiz('${pid}','${b.id}')">ìˆ˜ì •</button>
        <button class="btn btn-d btn-xs" onclick="delBiz('${pid}','${b.id}')">ì‚­ì œ</button>
      </div></td>
    </tr>`;
  }).join('');
}

// FIX 4: submitBiz - ì¦‰ì‹œ BIZ ë°°ì—´ ì—…ë°ì´íŠ¸
async function submitBiz(pid){
  const name=(pE(pid,'b_name')||E(mk(pid,'b_name'))||{value:''}).value.trim();if(!name){alert('ì—…ì²´ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
  const editId=(pE(pid,'b_editid')||E(mk(pid,'b_editid'))||{value:''}).value;
  const gv=(base)=>(pE(pid,base)||E(mk(pid,base))||{value:''}).value.trim();
  const entry={name,reg:gv('b_reg'),contractStart:gv('b_cs'),contractEnd:gv('b_ce'),url:gv('b_url'),form:gv('b_form'),visit:gv('b_visit'),r2:gv('b_r2'),r3:gv('b_r3')};
  const id=editId||uid();
  // ì¦‰ì‹œ ë¡œì»¬ ì—…ë°ì´íŠ¸ (Firebase ì‘ë‹µ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³ )
  const idx=BIZ.findIndex(b=>b.id===id);
  if(idx>=0)BIZ[idx]={id,...BIZ[idx],...entry};else BIZ.push({id,...entry});
  // ëª¨ë“  íŒ¨ë„ ë Œë”ë§
  panels.forEach(p=>{if(p.pageKey==='bizm')renderBizM(p.id);});
  fillAllBizSels();
  // Firebase ì €ì¥ (ë°±ê·¸ë¼ìš´ë“œ)
  if(db){fsSet('businesses',id,entry).catch(e=>toast('Firebase ì €ì¥ ì˜¤ë¥˜: '+e.message,'var(--dn)'));}
  cancelBizEdit(pid);
  toast('âœ“ ì €ì¥ë¨','var(--a2)');
}

function editBiz(pid,id){
  const b=BIZ.find(b=>b.id===id);if(!b)return;
  const sv=(base,v)=>{const el=pE(pid,base)||E(mk(pid,base));if(el)el.value=ss(v);};
  sv('b_name',b.name);sv('b_reg',b.reg);sv('b_cs',b.contractStart);sv('b_ce',b.contractEnd);sv('b_url',b.url);sv('b_form',b.form);sv('b_visit',b.visit);sv('b_r2',b.r2);sv('b_r3',b.r3);
  const editid=pE(pid,'b_editid')||E(mk(pid,'b_editid'));if(editid)editid.value=id;
  const ft=pE(pid,'bizm_ftitle')||E(mk(pid,'bizm_ftitle'));if(ft)ft.textContent='âœï¸ ì—…ì²´ ìˆ˜ì •';
  const sb=pE(pid,'b_savebtn')||E(mk(pid,'b_savebtn'));if(sb)sb.textContent='ì €ì¥';
}
async function delBiz(pid,id){
  if(!confirm('ì—…ì²´ ì‚­ì œ? í•´ë‹¹ ì—…ì²´ ë¸”ë¡œê±°Â·í‚¤ì›Œë“œ ë°ì´í„°ë„ ì‚­ì œë©ë‹ˆë‹¤.'))return;
  BIZ=BIZ.filter(b=>b.id!==id);fillAllBizSels();
  panels.forEach(p=>{if(p.pageKey==='bizm')renderBizM(p.id);});
  if(db){await fsDel('businesses',id);const bd=BIZB.filter(e=>e.bizId===id).map(e=>fsDel('bizBloggers',e.id));const kd=KWDS.filter(k=>k.bizId===id).map(k=>fsDel('keywords',k.id));await Promise.all([...bd,...kd]);}
  toast('ì‚­ì œë¨','var(--dn)');
}
function cancelBizEdit(pid){
  ['b_name','b_reg','b_cs','b_ce','b_url','b_form','b_visit','b_r2','b_r3','b_editid'].forEach(base=>{const el=pE(pid,base)||E(mk(pid,base));if(el)el.value='';});
  const ft=pE(pid,'bizm_ftitle')||E(mk(pid,'bizm_ftitle'));if(ft)ft.textContent='âš¡ ì—…ì²´ ì¶”ê°€';
  const sb=pE(pid,'b_savebtn')||E(mk(pid,'b_savebtn'));if(sb)sb.textContent='+ ì—…ì²´ ì¶”ê°€';
}

// â•â•â•â• í‚¤ì›Œë“œ ê´€ë¦¬ â•â•â•â•
function initKwm(pid){
  const sel=pE(pid,'bizsel')||E(mk(pid,'bizsel'));if(!sel)return;
  sel.innerHTML='<option value="">-- ì—…ì²´ ì„ íƒ --</option>'+BIZ.map(b=>`<option value="${b.id}">${x(b.name)}</option>`).join('');
}
function renderKeywords(pid){
  const bizId=(pE(pid,'bizsel')||E(mk(pid,'bizsel'))||{value:''}).value;
  const container=pE(pid,'kw_list')||E(mk(pid,'kw_list'));if(!container)return;
  const list=KWDS.filter(k=>k.bizId===bizId);
  if(!list.length){container.innerHTML='<div class="empty"><div class="empty-icon">ğŸ”‘</div><div class="empty-text">í‚¤ì›Œë“œë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</div></div>';return;}
  container.innerHTML=list.map(k=>`<div class="kw-item" onclick="editKw('${pid}','${k.id}')"><div class="kw-name">${x(k.name)}</div><div class="kw-meta">ì‚¬ì´ì¦ˆ: ${x(k.size)||'-'} | ê²½ìŸê°•ë„: ${x(k.comp)||'-'} | ìŠ¤ë§ˆíŠ¸ë¸”ë¡: ${x(k.smartSummary)||'-'}</div></div>`).join('');
}
function openKwAdd(pid){
  const bizId=(pE(pid,'bizsel')||E(mk(pid,'bizsel'))||{value:''}).value;if(!bizId){alert('ì—…ì²´ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');return;}
  ['kw_id','kw_name','kw_size','kw_comp','kw_smart'].forEach(b=>{const el=pE(pid,b)||E(mk(pid,b));if(el)el.value='';});
  const t=pE(pid,'kw_formtitle')||E(mk(pid,'kw_formtitle'));if(t)t.textContent='í‚¤ì›Œë“œ ì¶”ê°€';
  const fp=pE(pid,'kw_formpanel')||E(mk(pid,'kw_formpanel'));if(fp)fp.style.display='block';
}
function editKw(pid,id){
  const k=KWDS.find(k=>k.id===id);if(!k)return;
  const sv=(base,v)=>{const el=pE(pid,base)||E(mk(pid,base));if(el)el.value=ss(v);};
  sv('kw_id',k.id);sv('kw_name',k.name);sv('kw_size',k.size);sv('kw_comp',k.comp);sv('kw_smart',k.smartRaw||'');
  const t=pE(pid,'kw_formtitle')||E(mk(pid,'kw_formtitle'));if(t)t.textContent='í‚¤ì›Œë“œ ìˆ˜ì •';
  const fp=pE(pid,'kw_formpanel')||E(mk(pid,'kw_formpanel'));if(fp)fp.style.display='block';
  calcSmartPrev(pid);
}
function calcSmartPrev(pid){
  const raw=(pE(pid,'kw_smart')||E(mk(pid,'kw_smart'))||{value:''}).value;const prev=pE(pid,'kw_smartprev')||E(mk(pid,'kw_smartprev'));if(!prev)return;
  if(!raw.trim()){prev.textContent='';return;}
  const entries=raw.trim().split(/\s+/).map(s=>{const[lv,rk]=s.split('/');return{lv:parseFloat(lv)||0,rk:parseFloat(rk)||0};}).filter(e=>e.lv>0);
  if(!entries.length){prev.textContent='';return;}
  const lvs=entries.map(e=>e.lv);const maxRk=Math.max(...entries.map(e=>e.rk));
  const minLv=Math.min(...lvs),maxLv=Math.max(...lvs);
  prev.textContent=`â†’ ${minLv===maxLv?`LV${minLv}`:`LV${minLv}~${maxLv}`} / ìˆœìœ„ ${maxRk}ìœ„`;
}
async function saveKeyword(pid){
  const bizId=(pE(pid,'bizsel')||E(mk(pid,'bizsel'))||{value:''}).value;if(!bizId)return;
  const name=(pE(pid,'kw_name')||E(mk(pid,'kw_name'))||{value:''}).value.trim();if(!name){alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');return;}
  const raw=(pE(pid,'kw_smart')||E(mk(pid,'kw_smart'))||{value:''}).value;
  const entries=raw.trim().split(/\s+/).map(s=>{const[lv,rk]=s.split('/');return{lv:parseFloat(lv)||0,rk:parseFloat(rk)||0};}).filter(e=>e.lv>0);
  let smartSummary='';
  if(entries.length){const lvs=entries.map(e=>e.lv);const maxRk=Math.max(...entries.map(e=>e.rk));const minLv=Math.min(...lvs),maxLv=Math.max(...lvs);smartSummary=`${minLv===maxLv?`LV${minLv}`:`LV${minLv}~${maxLv}`}/ìˆœìœ„${maxRk}ìœ„`;}
  const editId=(pE(pid,'kw_id')||E(mk(pid,'kw_id'))||{value:''}).value;
  await fsSet('keywords',editId||uid(),{bizId,name,size:(pE(pid,'kw_size')||E(mk(pid,'kw_size'))||{value:''}).value,comp:(pE(pid,'kw_comp')||E(mk(pid,'kw_comp'))||{value:''}).value,smartRaw:raw,smartEntries:entries,smartSummary,addedDate:ISO()});
  const fp=pE(pid,'kw_formpanel')||E(mk(pid,'kw_formpanel'));if(fp)fp.style.display='none';
  toast('âœ“ í‚¤ì›Œë“œ ì €ì¥ë¨','var(--a2)');
}

// â•â•â•â• í‚¤ì›Œë“œ ì¶”ì²œ â•â•â•â•
function initKwrec(pid){
  const sel=pE(pid,'bizsel')||E(mk(pid,'bizsel'));if(!sel)return;
  sel.innerHTML='<option value="">-- ì—…ì²´ ì„ íƒ --</option>'+BIZ.map(b=>`<option value="${b.id}">${x(b.name)}</option>`).join('');
}
function loadRecBiz(pid){
  if(!recState[pid])recState[pid]={kws:new Set(),blogger:null};
  recState[pid].kws.clear();recState[pid].blogger=null;
  const bizId=(pE(pid,'bizsel')||E(mk(pid,'bizsel'))||{value:''}).value;
  const kws=KWDS.filter(k=>k.bizId===bizId).sort((a,b)=>(String(b.size)||'').localeCompare(String(a.size)||''));
  const kl=pE(pid,'rec_kwlist')||E(mk(pid,'rec_kwlist'));
  if(kl)kl.innerHTML=kws.length?kws.map(k=>`<div class="kw-item" id="${mk(pid,'rkw_'+k.id)}" onclick="toggleRecKw('${pid}','${k.id}')"><div class="kw-name">${x(k.name)}</div><div class="kw-meta">ì‚¬ì´ì¦ˆ: ${x(k.size)||'-'} | ${x(k.smartSummary)||'-'}</div></div>`).join(''):'<div style="color:var(--m);font-size:11px;padding:8px;">í‚¤ì›Œë“œ ì—†ìŒ</div>';
  const bl=pE(pid,'rec_blist')||E(mk(pid,'rec_blist'));
  const bloggers=BIZB.filter(e=>e.bizId===bizId);
  if(bl)bl.innerHTML=bloggers.length?bloggers.map(b=>`<div class="sri" id="${mk(pid,'rbl_'+b.id)}" onclick="selectRecBlogger('${pid}','${b.id}')"><div><strong>${x(b.nick)}</strong><div style="font-size:10px;color:var(--m);">IDX:${x(b.idx)||'-'} RK:${x(b.rk)||'-'} LV:${x(b.lv)||'-'} ìˆœìœ„:${x(b.rank)||'-'}</div></div></div>`).join(''):'<div style="padding:10px;font-size:11px;color:var(--m);">ë¸”ë¡œê±° ì—†ìŒ</div>';
  showRecResult(pid);
}
function toggleRecKw(pid,id){
  if(!recState[pid])recState[pid]={kws:new Set(),blogger:null};
  if(recState[pid].kws.has(id))recState[pid].kws.delete(id);else recState[pid].kws.add(id);
  document.querySelectorAll(`[id^="${mk(pid,'rkw_')}"]`).forEach(el=>{const kwId=el.id.replace(mk(pid,'rkw_'),'');el.classList.toggle('selected',recState[pid].kws.has(kwId));});
  showRecResult(pid);
}
function selectRecBlogger(pid,id){
  if(!recState[pid])recState[pid]={kws:new Set(),blogger:null};
  recState[pid].blogger=id;
  document.querySelectorAll(`[id^="${mk(pid,'rbl_')}"]`).forEach(el=>{const bId=el.id.replace(mk(pid,'rbl_'),'');el.style.background=bId===id?'rgba(91,94,244,.08)':'';});
  showRecResult(pid);
}
function showRecResult(pid){
  const st=recState[pid]||{};const rp=pE(pid,'rec_result')||E(mk(pid,'rec_result'));const re=pE(pid,'rec_empty')||E(mk(pid,'rec_empty'));
  if(!st.blogger||!st.kws||st.kws.size===0){if(rp)rp.style.display='none';if(re)re.style.display='block';return;}
  if(rp)rp.style.display='block';if(re)re.style.display='none';
  const b=BIZB.find(e=>e.id===st.blogger);
  const bi=pE(pid,'rec_binfo')||E(mk(pid,'rec_binfo'));if(bi&&b)bi.innerHTML=`<div class="ctitle">ë¸”ë¡œê±° ì •ë³´</div><div style="font-size:12px;"><strong>${x(b.nick)}</strong><br>IDX: ${idxBadge(b.idx)}<br><span style="font-size:11px;color:var(--m);">RK: ${x(b.rk)||'-'} | LV: ${x(b.lv)||'-'} | ìˆœìœ„: ${x(b.rank)||'-'} | SC: ${x(b.sc)||'-'}</span></div>`;
  const selKws=[...st.kws].map(id=>KWDS.find(k=>k.id===id)).filter(Boolean);
  const ki=pE(pid,'rec_kinfo')||E(mk(pid,'rec_kinfo'));if(ki)ki.innerHTML=`<div class="ctitle">ì„ íƒ í‚¤ì›Œë“œ (${selKws.length}ê°œ)</div>`+selKws.map(k=>`<div class="kw-item"><div class="kw-name">${x(k.name)}</div><div class="kw-meta">ì‚¬ì´ì¦ˆ: ${x(k.size)||'-'} | ê²½ìŸê°•ë„: ${x(k.comp)||'-'} | ìŠ¤ë§ˆíŠ¸ë¸”ë¡: ${x(k.smartSummary)||'-'}</div></div>`).join('');
}

// â•â•â•â• ì„¤ì • â•â•â•â•
function renderSettings(pid){
  const el=pE(pid,'fb_status')||E(mk(pid,'fb_status'));
  if(el)el.textContent=db?`âœ“ Firebase ì—°ê²°ë¨ (${FB_CFG.projectId})`:'âœ— Firebase ë¯¸ì—°ê²° - FB_CFGë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
  if(el)el.className=db?'notice n-ok':'notice n-w';
  const settings=JSON.parse(localStorage.getItem('mm_nw')||'{}');
  const sv=(base,v)=>{const el=pE(pid,base)||E(mk(pid,base));if(el)el.value=ss(v);};
  sv('nw_cid',settings.clientId);sv('nw_cs',settings.clientSecret);sv('nw_uid',settings.userId);sv('nw_token',settings.accessToken);
  const kt=pE(pid,'kakao_token')||E(mk(pid,'kakao_token'));if(kt)kt.value=localStorage.getItem('mm_kakao')||'';
}
function saveNWSettings(pid){
  const gv=(base)=>(pE(pid,base)||E(mk(pid,base))||{value:''}).value;
  const settings={clientId:gv('nw_cid'),clientSecret:gv('nw_cs'),userId:gv('nw_uid'),accessToken:gv('nw_token')};
  localStorage.setItem('mm_nw',JSON.stringify(settings));toast('âœ“ ë„¤ì´ë²„ì›ìŠ¤ ì„¤ì • ì €ì¥ë¨','var(--a2)');
}
async function testNWMail(pid){
  const settings=JSON.parse(localStorage.getItem('mm_nw')||'{}');
  if(!settings.accessToken||!settings.userId){alert('ì„¤ì •ì„ ë¨¼ì € ì €ì¥í•´ì£¼ì„¸ìš”.');return;}
  const testTo=prompt('í…ŒìŠ¤íŠ¸ ë©”ì¼ ì£¼ì†Œ:');if(!testTo)return;
  try{await sendNWMail(settings,testTo,'[í…ŒìŠ¤íŠ¸] ë§ˆì¸ì¦ˆë§ˆì¼€íŒ…','ë„¤ì´ë²„ì›ìŠ¤ ë©”ì¼ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.');toast('âœ“ í…ŒìŠ¤íŠ¸ ë©”ì¼ ë°œì†¡ë¨','var(--a2)');}
  catch(e){toast('ë°œì†¡ ì‹¤íŒ¨: '+e.message,'var(--dn)');}
}
function saveKakaoSettings(pid){localStorage.setItem('mm_kakao',(pE(pid,'kakao_token')||E(mk(pid,'kakao_token'))||{value:''}).value||'');toast('âœ“ ì¹´ì¹´ì˜¤ ì„¤ì • ì €ì¥ë¨','var(--a2)');}

// â•â•â•â• LOGIN â•â•â•â•
async function doLogin(){
  const email=E('login-email').value.trim();
  const pw=E('login-pw').value;
  const err=E('login-err');
  if(!email||!pw){err.textContent='ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';return;}
  err.textContent='';
  try{
    await auth.signInWithEmailAndPassword(email,pw);
  }catch(e){
    const msg={
      'auth/invalid-email':'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
      'auth/user-not-found':'ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.',
      'auth/wrong-password':'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.',
      'auth/invalid-credential':'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.',
      'auth/too-many-requests':'ë„ˆë¬´ ë§ì€ ì‹œë„ê°€ ìˆì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
    };
    err.textContent=msg[e.code]||'ë¡œê·¸ì¸ ì‹¤íŒ¨: '+e.message;
  }
}
async function doLogout(){
  if(!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  await auth.signOut();
}

// â•â•â•â• START â•â•â•â•
document.addEventListener('DOMContentLoaded',()=>{
  if(!auth){
    E('login-screen').classList.add('hide');
    startListeners();
    return;
  }
  auth.onAuthStateChanged(user=>{
    if(user){
      E('login-screen').classList.add('hide');
      const userEl=E('login-user');if(userEl)userEl.textContent=user.email;
      if(panels.length===0)startListeners();
    }else{
      E('login-screen').classList.remove('hide');
      E('loading').classList.add('hide');
      panels.length=0;
      const body=E('appbody');if(body)body.innerHTML='';
      const bar=E('ctbar');if(bar)bar.innerHTML='';
    }
  });
});
</script>
</body>
</html>